<?xml version="1.0" encoding="UTF-8"?>
<chapter id="index"><?dbhtml dir="docker" ?>
	<title>Docker</title>
	<para><ulink url="https://www.docker.com" /></para>
	&chapter.docker.install.xml;
	<section id="docker.config">
		<title>配置 Docker</title>
		<section id="">
			<title>开启远程访问</title>
			<para>修改/etc/sysconfig/docker文件，在最后增加一行DOCKER_OPTS</para>
			<para>vim /etc/sysconfig/docker</para>
			<screen>
			<![CDATA[
DOCKER_OPTS="-H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375"
			]]>
			</screen>
			<para>修改/usr/lib/systemd/system/docker.service 在[Service]的ExexStart=下面增加一行$DOCKER_OPTS</para>
			<screen>
			<![CDATA[
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
BindsTo=containerd.service
After=network-online.target firewalld.service
Wants=network-online.target
Requires=docker.socket

[Service]
Type=notify
# the default is not to use systemd for cgroups because the delegate issues still
# exists and systemd currently does not support the cgroup feature set required
# for containers run by docker
EnvironmentFile=-/etc/sysconfig/docker
ExecStart=/usr/bin/dockerd $DOCKER_OPTS
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always

# Note that StartLimit* options were moved from "Service" to "Unit" in systemd 229.
# Both the old, and new location are accepted by systemd 229 and up, so using the old location
# to make them work for either version of systemd.
StartLimitBurst=3

# Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230.
# Both the old, and new name are accepted by systemd 230 and up, so using the old name to make
# this option work for either version of systemd.
StartLimitInterval=60s

# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity

# Comment TasksMax if your systemd version does not supports it.
# Only systemd 226 and above support this option.
TasksMax=infinity

# set delegate yes so that systemd does not reset the cgroups of docker containers
Delegate=yes

# kill only the docker process, not all processes in the cgroup
KillMode=process

[Install]
WantedBy=multi-user.target
			]]>
			</screen>
			<para>重启 docker </para>
			<screen>
			<![CDATA[
[root@localhost ~]# systemctl daemon-reload
[root@localhost ~]# systemctl restart docker			
			]]>
			</screen>
			<para>查看端口</para>
			<screen>
			<![CDATA[
[root@localhost ~]# ss -lnt | grep 2375
LISTEN     0      1024        :::2375                    :::*  			
			]]>
			</screen>
			<para>检查 docker 信息</para>
			<screen>
			<![CDATA[
[root@localhost ~]# curl -s http://localhost:2375/info
{"ID":"YNK5:OJTT:FELN:H4DQ:AG7H:W3RE:WGLD:TOOI:32CH:S6HR:AJ45:4VLZ","Containers":4,"ContainersRunning":0,"ContainersPaused":0,"ContainersStopped":4,"Images":10,"Driver":"btrfs","DriverStatus":[["Build Version","Btrfs v4.9.1"],["Library Version","102"]],"SystemStatus":null,"Plugins":{"Volume":["local"],"Network":["bridge","host","macvlan","null","overlay"],"Authorization":null,"Log":["awslogs","fluentd","gcplogs","gelf","journald","json-file","local","logentries","splunk","syslog"]},"MemoryLimit":true,"SwapLimit":true,"KernelMemory":true,"CpuCfsPeriod":true,"CpuCfsQuota":true,"CPUShares":true,"CPUSet":true,"IPv4Forwarding":true,"BridgeNfIptables":false,"BridgeNfIp6tables":false,"Debug":false,"NFd":23,"OomKillDisable":true,"NGoroutines":37,"SystemTime":"2019-01-24T23:30:56.230913047-05:00","LoggingDriver":"json-file","CgroupDriver":"cgroupfs","NEventsListener":0,"KernelVersion":"3.10.0-693.el7.x86_64","OperatingSystem":"CentOS Linux 7 (Core)","OSType":"linux","Architecture":"x86_64","IndexServerAddress":"https://index.docker.io/v1/","RegistryConfig":{"AllowNondistributableArtifactsCIDRs":[],"AllowNondistributableArtifactsHostnames":[],"InsecureRegistryCIDRs":["127.0.0.0/8"],"IndexConfigs":{"docker.io":{"Name":"docker.io","Mirrors":[],"Secure":true,"Official":true}},"Mirrors":[]},"NCPU":2,"MemTotal":1958645760,"GenericResources":null,"DockerRootDir":"/var/lib/docker","HttpProxy":"","HttpsProxy":"","NoProxy":"","Name":"localhost.localdomain","Labels":[],"ExperimentalBuild":false,"ServerVersion":"18.09.1","ClusterStore":"","ClusterAdvertise":"","Runtimes":{"runc":{"path":"runc"}},"DefaultRuntime":"runc","Swarm":{"NodeID":"","NodeAddr":"","LocalNodeState":"inactive","ControlAvailable":false,"Error":"","RemoteManagers":null},"LiveRestoreEnabled":false,"Isolation":"","InitBinary":"docker-init","ContainerdCommit":{"ID":"9754871865f7fe2f4e74d43e2fc7ccd237edcbce","Expected":"9754871865f7fe2f4e74d43e2fc7ccd237edcbce"},"RuncCommit":{"ID":"96ec2177ae841256168fcf76954f7177af9446eb","Expected":"96ec2177ae841256168fcf76954f7177af9446eb"},"InitCommit":{"ID":"fec3683","Expected":"fec3683"},"SecurityOptions":["name=seccomp,profile=default"],"ProductLicense":"Community Engine","Warnings":["WARNING: API is accessible on http://0.0.0.0:2375 without encryption.\n         Access to the remote API is equivalent to root access on the host. Refer\n         to the 'Docker daemon attack surface' section in the documentation for\n         more information: https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface","WARNING: bridge-nf-call-iptables is disabled","WARNING: bridge-nf-call-ip6tables is disabled"]}			
			]]>
			</screen>
		</section>
	</section>
	
	<section id="images">
		<title>镜像</title>
		<para>Docker 镜像地址 <ulink url="https://registry.hub.docker.com/">https://registry.hub.docker.com/</ulink></para>
		<section>
			<title>搜索镜像</title>
			<screen>
			<![CDATA[
$ sudo docker search centos |more
NAME                                            DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
centos                                          The official build of CentOS.                   542       [OK]       
tianon/centos                                   CentOS 5 and 6, created using rinse instea...   28                   
ansible/centos7-ansible                         Ansible on Centos7                              13                   [OK]
saltstack/centos-6-minimal                                                                      7                    [OK]
blalor/centos                                   Bare-bones base CentOS 6.5 image                7                    [OK]
steeef/graphite-centos                          CentOS 6.x with Graphite and Carbon via ng...   6                    [OK]
ariya/centos6-teamcity-server                   TeamCity Server 8.1 on CentOS 6                 6                    [OK]
tutum/centos                                    Centos image with SSH access. For the root...   5                    [OK]
tutum/centos-6.4                                DEPRECATED. Use tutum/centos:6.4 instead. ...   5                    [OK]			
			]]>
			</screen>
		</section>
		<section>
			<title>获取镜像</title>
			<para>可以使用 docker pull 命令来从官网仓库获取所需要的镜像。</para>
			<screen>
			<![CDATA[
			
$ sudo docker pull ubuntu:14.04
			]]>
			</screen>
			<para>等同于</para>
			<screen>
			<![CDATA[
$ sudo docker pull registry.hub.docker.com/ubuntu:14.04
			]]>
			</screen>
			<para>获得所有版本镜像</para>
			<screen>
			<![CDATA[
$ sudo docker pull ubuntu	

$ sudo docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
ubuntu              utopic              277eb4304907        3 days ago          215.6 MB
ubuntu              14.10               277eb4304907        3 days ago          215.6 MB
ubuntu              14.04               5506de2b643b        3 days ago          197.8 MB
ubuntu              trusty              5506de2b643b        3 days ago          197.8 MB
ubuntu              latest              5506de2b643b        3 days ago          197.8 MB
ubuntu              14.04.1             5506de2b643b        3 days ago          197.8 MB
ubuntu              precise             0b310e6bf058        3 days ago          116.1 MB
ubuntu              12.04.5             0b310e6bf058        3 days ago          116.1 MB
ubuntu              12.04               0b310e6bf058        3 days ago          116.1 MB
ubuntu              12.10               c5881f11ded9        4 months ago        172.1 MB
ubuntu              quantal             c5881f11ded9        4 months ago        172.1 MB
ubuntu              13.04               463ff6be4238        4 months ago        169.4 MB
ubuntu              raring              463ff6be4238        4 months ago        169.4 MB
ubuntu              13.10               195eb90b5349        4 months ago        184.6 MB
ubuntu              saucy               195eb90b5349        4 months ago        184.6 MB
ubuntu              10.04               3db9c44f4520        6 months ago        183 MB
ubuntu              lucid               3db9c44f4520        6 months ago        183 MB		
			]]>
			</screen>
			<para>从其他服务器获得镜像</para>
			<screen>
			<![CDATA[
$ sudo docker pull dl.dockerpool.com:5000/ubuntu:12.04
			]]>
			</screen>
			<para>完成后，即可随时使用该镜像了，例如创建一个容器，让其中运行 bash 应用。</para>
			<screen>
			<![CDATA[
$ sudo docker run -t -i ubuntu:14.10 /bin/bash
			]]>
			</screen>
		</section>
		<section>
			<title>列出本地镜像</title>
			<screen>
			<![CDATA[
$ sudo docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
ubuntu              14.10               277eb4304907        3 days ago          215.6 MB
ubuntu              latest              5506de2b643b        3 days ago          197.8 MB
			]]>
			</screen>
		</section>
		
		<section>
			<title>保存和载入镜像</title>
			<para>保存镜像</para>
			<screen>
			<![CDATA[
$sudo docker save -o ubuntu_14.10.tar ubuntu:14.10			
			]]>
			</screen>
			<para>载入镜像</para>
			<screen>
			<![CDATA[
$ sudo docker load --input ubuntu_14.10.tar
或
$ sudo docker load < ubuntu_14.10.tar
			]]>			
			</screen>
		</section>
		<section>
			<title>删除本地镜像</title>
			<screen>
			<![CDATA[
$ sudo docker rmi ubuntu:12.04
Untagged: ubuntu:12.04
			]]>
			</screen>
			<para>强制删除所有镜像</para>
			<screen>
			<![CDATA[
docker rmi -f $(docker images -q)			
			]]>
			</screen>
		</section>
		&chapter.docker.dockerfile.xml;
	</section>
	<section id="container">
		<title>容器</title>
		<section>
			<title>启动与终止容器</title>
			<screen>
			<![CDATA[
$ sudo docker run ubuntu:14.10 /bin/echo 'Hello world'
Hello world			
			]]>
			</screen>
			<para>进入BASH</para>
			<screen>
			<![CDATA[
$ sudo docker run -t -i ubuntu:14.10 /bin/bash
root@f8c7b2afff14:/# 			
			]]>
			</screen>
			<para>start / stop / restart</para>
			<screen>
			<![CDATA[
sudo docker start silly_bohr
silly_bohr

$ sudo docker stop silly_bohr
silly_bohr

$ sudo docker restart silly_bohr
silly_bohr
			]]>
			</screen>
			<para>守护进程运行</para>
			<screen>
			<![CDATA[
$ sudo docker run -d ubuntu:14.10 /bin/sh -c "while true; do echo hello world; sleep 1; done"
4cdbb75eeabf3f1ea87bec91accdf5211639d0895e94ab94ffa1d55fb7f62e2a
			]]>
			</screen>
			<para>通过 docker ps 命令来查看容器信息</para>
			<screen>
			<![CDATA[
$ sudo docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS               NAMES
4cdbb75eeabf        ubuntu:14.10        "/bin/sh -c 'while t   30 seconds ago      Up 28 seconds                           drunk_rosalind 
			]]>
			</screen>
			<para>要获取容器的输出信息，可以通过 docker logs 命令。</para>
			<screen>
			<![CDATA[
$ sudo docker logs insane_babbage			
			]]>
			</screen>
			<para>注意：守护进程在后台运行，所以无输出，只能通过docker logs 命令查看</para>
		</section>
		<section>
			<title>进入容器</title>
			<screen>
			<![CDATA[
$ sudo docker run -idt ubuntu:14.10
793f9805620d7e10564e0778c388640cb73b6a1aec663bf468904d72a4f219f2

$ sudo docker ps 
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
793f9805620d        ubuntu:14.10        "/bin/bash"         5 seconds ago       Up 4 seconds                            mad_elion           

$ sudo docker attach mad_elion 
root@793f9805620d:/# ls
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
			]]>
			</screen>
		</section>
		<section>
			<title>导出和导入容器</title>
			<para></para>
			<screen>
			<![CDATA[
$ sudo docker export 7691a814370e > ubuntu.tar
			]]>			
			</screen>
			<para></para>
			<screen>
			<![CDATA[
			<![CDATA[
$ cat ubuntu.tar | sudo docker import - test/ubuntu:v1.0
			]]>			
			</screen>
			<para>指定 URL 或者某个目录来导入，例如</para>
			<screen>
			<![CDATA[
$sudo docker import http://example.com/exampleimage.tgz example/imagerepo			
			]]>
			</screen>
		</section>
		<section id="kill">
			<title>kill</title>
			<para>杀死所有正在运行的容器</para>
			<screen>
			<![CDATA[
docker kill $(docker ps -a -q)			
			]]>
			</screen>
		</section>
		<section>
			<title>删除容器</title>
			<para>使用 docker rm 来删除一个处于终止状态的容器。</para>
			<screen>
			<![CDATA[
$ sudo docker ps -a
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS                      PORTS               NAMES
f8c7b2afff14        ubuntu:14.10        "/bin/bash"            14 minutes ago      Exited (0) 2 minutes ago                        agitated_fermat     
0abd2e5fc251        ubuntu:14.10        "/bin/echo 'Hello wo   15 minutes ago      Exited (0) 15 minutes ago                       clever_kowalevski 

$ sudo docker rm clever_kowalevski
clever_kowalevski

$ sudo docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
f8c7b2afff14        ubuntu:14.10        "/bin/bash"         16 minutes ago      Exited (0) 5 minutes ago                       agitated_fermat     			
			]]>
			</screen>
			<para></para>
			<screen>
			<![CDATA[
$ docker rm 719f98391ecf1d6f1f153ffea1bbd84cd2dc9cf6d31d5a4f348c60d98392814c
			]]>
			</screen>
			<para>删除所有已经停止的容器</para>
			<screen>
			<![CDATA[
docker rm $(docker ps -a -q)			
			]]>
			</screen>
		</section>
		
	</section>
	<section id="repository">
		<title>仓库</title>
		<section>
			<title>登陆仓库</title>
			<para>登录</para>
			<screen>
			<![CDATA[
$ sudo docker login
Username: netkiller
Password: 
Email: netkiller@msn.com
Login Succeeded
			]]>
			</screen>
		</section>
		<section>
			<title>获取镜像</title>
			<screen>
			<![CDATA[
docker pull ubuntu:14.04
			]]>
			</screen>
		</section>
		<section>
			<title>上传镜像</title>
			<screen>
			<![CDATA[
docker tag friendlyhello username/repository:tag
docker push username/repository:tag
			]]>
			</screen>
		</section>
	</section>

	<section id="docker.volume">
		<title>卷管理</title>
		<section>
			<title>列出卷 </title>
			<para>docker volume ls</para>
			<screen>
			<![CDATA[
# docker volume ls
DRIVER              VOLUME NAME
local               dbac41b6de88c75d2932d5949367b17f347f482977d508195375dbc71518ab27
			]]>
			</screen>
		</section>
		<section>
			<title>创建卷</title>
			<screen>
			<![CDATA[
# docker volume create --name WebVolume1
WebVolume1
			]]>
			</screen>
			<para></para>
			<screen>
			<![CDATA[
# docker volume ls
DRIVER              VOLUME NAME
local               WebVolume1
local               dbac41b6de88c75d2932d5949367b17f347f482977d508195375dbc71518ab27			
			]]>
			</screen>
			
		</section>
		<section>
			<title>挂在镜像</title>
			<screen>
			<![CDATA[
# docker run -ti --rm -v WebVolume1:/www ubuntu
# docker run -ti --rm -v WebVolume1:/www docker.io/centos:7
			]]>
			</screen>
			<para>查看卷的挂载情况</para>
			<screen>
			<![CDATA[
# df | grep /www
/dev/vda1       20510332 7943940  11501484  41% /www			
			]]>
			</screen>
			<para>创建测试文件</para>
			<screen>
			<![CDATA[
# mkdir -p /www/netkiller.cn/www.netkiller.cn
# echo Helloworld > /www/netkiller.cn/www.netkiller.cn/index.html
# cat /www/netkiller.cn/www.netkiller.cn/index.html
Helloworld
# exit
exit
			]]>
			</screen>
		</section>
		<section>
			<title>检查卷</title>
			<screen>
			<![CDATA[
# docker volume inspect WebVolume1
[
    {
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/WebVolume1/_data",
        "Name": "WebVolume1",
        "Options": {},
        "Scope": "local"
    }
]
			]]>
			</screen>
		</section>
		<section>
			<title>删除卷</title>
			<screen>
			<![CDATA[
# docker volume create AppVolume1
# docker volume rm AppVolume1
			]]>
			</screen>	
		</section>
		<section>
			<title>销毁所有未使用的卷</title>
			<screen>
			<![CDATA[
# docker volume prune
WARNING! This will remove all volumes not used by at least one container.
Are you sure you want to continue? [y/N] y
Deleted Volumes:
WebVolume1
3fd379f8c2cf8727d2e83e84e434ea1f122016957bd7cf78a0f05b6e5a69cf2b
app

Total reclaimed space: 11 B
			]]>
			</screen>
		</section>
		<section>
			<title>在多个容器间共享卷</title>
			<para>容器一</para>
			<screen>
			<![CDATA[
# docker run -ti --name=Container1 -v DataVolume1:/opt/data ubuntu
			]]>
			</screen>
			<para>容器二</para>
			<screen>
			<![CDATA[
# docker run -ti --name=Container2 --volumes-from Container1 ubuntu
			]]>
			</screen>
			<para>进入容器一中查看数据</para>
			<screen>
			<![CDATA[
# docker start -ai Container1
			]]>
			</screen>
			<para>容器三，挂在只读卷</para>
			<screen>
			<![CDATA[
# docker run -ti --name=Container3 --volumes-from Container2:ro ubuntu
			]]>			
			</screen>
			<para>删除上面三个测试容易和卷</para>
			<screen>
			<![CDATA[
# docker rm Container1 Container2 Container3
# docker volume rm DataVolume1
			]]>
			</screen>
		</section>
		<section>
			<title>容器绑定本地文件系统</title>
			<subtitle>Bind mount a volume (default [])</subtitle>
			<screen>
			<![CDATA[
# docker run -it --name mycentos1 -v /www:/tmp/test docker.io/centos:7 /bin/bash
# docker run -d -v ~/logs:/var/log/nginx -p 80:80 -i nginx			
			]]>
			</screen>
		</section>
	</section>
	&chapter.docker.system.xml;
	&chapter.docker.cli.xml;	
	&chapter.docker-compose.xml;
	&section.docker.registry.xml;
	&chapter.docker.example.xml;
</chapter>