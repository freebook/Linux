<?xml version="1.0" encoding="UTF-8"?>
<chapter id="freeswitch">
	<title>FreeSWITCH</title>
	<ulink url="https://www.freeswitch.org/" />
	<section id="freeswitch.docker">
		<title>Docker 安装</title>
		<screen>
		<![CDATA[
docker volume create --name freeswitch-sounds 		
docker pull safarov/freeswitch:latest
docker run --net=host --name freeswitch \
           -e SOUND_RATES=8000:16000 \
           -e SOUND_TYPES=music:en-us-callie \
           -v freeswitch-sounds:/usr/share/freeswitch/sounds \
           -v /etc/freeswitch/:/etc/freeswitch \
           safarov/freeswitch	
		]]>
		</screen>
		<para>netkiller-devops Docker 编排工具</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# pip install netkiller-devops		
[root@netkiller ~]# cat freeswitch.py 
#!/usr/bin/env python3
##################################################
# Home  : https://www.netkiller.cn
# Author: Neo <netkiller@msn.com>
# Upgrade: 2026-02-09
# Docker freeswitch
##################################################

import sys

try:
    sys.path.insert(0, ".")
    from netkiller.docker import *
except ModuleNotFoundError as err:
    print("pip install netkiller-devops, %s" % (err))
    exit()

# -----------------------------------------------------------------------------------------------
development = Composes("development")
testing = Composes("testing")
production = Composes("production")
# -----------------------------------------------------------------------------------------------
volumes = Volumes("freeswitch-sounds")

freeswitch = Services("freeswitch")
freeswitch.container_name("freeswitch")
freeswitch.image("safarov/freeswitch:latest")
freeswitch.restart("unless-stopped")
freeswitch.environment({"SOUND_RATES": "8000:16000", "SOUND_TYPES": "music:en-us-callie"})
freeswitch.volumes(["freeswitch-sounds:/usr/share/freeswitch/sounds","/etc/freeswitch/:/etc/freeswitch"])
freeswitch.network_mode('host')
#freeswitch.ports(["5060:5060","5060:5060/udp","16384-32768:16384-32768/udp","5066:5066","7443:7443"])
# freeswitch.working_dir("/app")
development.services(freeswitch)
development.volumes(volumes)
# -----------------------------------------------------------------------------------------------
if __name__ == "__main__":
    try:
        docker = Docker()
        docker.none()
        # docker.env({'DOCKER_HOST':'ssh://root@192.168.30.13','COMPOSE_PROJECT_NAME':'experiment'})
        # docker.sysctl({"vm.overcommit_memory": "1"})
        docker.environment(development)
        # docker.environment(testing)
        # docker.environment(production)
        docker.main()
    except KeyboardInterrupt:
        print("Crtl+C Pressed. Shutting down.")		
		]]>
		</screen>
		<para>安装用户管理工具</para>
		<screen>
		<![CDATA[
pip install freeswitch			
		]]>
		</screen>
		<section>
			<title>配置 freeswitch</title>
			<section id="freeswitch.etc">
				<title>备份 freeswitch 配置文件</title>
				<screen>
				<![CDATA[
cp /etc/freeswitch/vars.xml{,.backup}
cp /etc/freeswitch/sip_profiles/internal.xml{,.backup}
cp /etc/freeswitch/sip_profiles/external.xml{,.backup}
cp /etc/freeswitch/dialplan/default.xml{,.backup}
cp /etc/freeswitch/dialplan/public.xml{,.backup}
cp /etc/freeswitch/tls/wss.pem{,.backup}
				]]>
				</screen>
			</section>
			<section>
				<title>基本配置</title>
				<para>修改默认密码</para>
				<screen>
				<![CDATA[
  <X-PRE-PROCESS cmd="set" data="default_password=13113668890" />				
				]]>
				</screen>
				<para>配置SIP域</para>
				<screen>
				<![CDATA[
  <X-PRE-PROCESS cmd="set" data="domain=pbx.netkiller.cn"/>				
				]]>
				</screen>
				<para>监听端口修改未 5061</para>
				<screen>
				<![CDATA[
 <X-PRE-PROCESS cmd="set" data="internal_sip_port=5061"/>
				]]>
				</screen>
			</section>
			<section>
				<title>配置拨出规则号段</title>
				<screen>
				<![CDATA[
    <extension name="Local_Extension">
        <condition field="destination_number" expression="^(1\d{2,3}|46\d{5})$">
        <action application="export" data="dialed_extension=$1"/>
        <!-- bind_meta_app can have these args <key> [a|b|ab] [a|b|o|s] <app> -->
        <action application="bind_meta_app" data="1 b s execute_extension::dx XML features"/>
        <action application="bind_meta_app" data="2 b s record_session::$${recordings_dir}/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"/>
        <action application="bind_meta_app" data="3 b s execute_extension::cf XML features"/>
        <action application="bind_meta_app" data="4 b s execute_extension::att_xfer XML features"/>
        <action application="set" data="ringback=${us-ring}"/>
        <action application="set" data="transfer_ringback=$${hold_music}"/>
        <action application="set" data="call_timeout=30"/>
        <!-- <action application="set" data="sip_exclude_contact=${network_addr}"/> -->
        <action application="set" data="hangup_after_bridge=true"/>
        <!--<action application="set" data="continue_on_fail=NORMAL_TEMPORARY_FAILURE,USER_BUSY,NO_ANSWER,TIMEOUT,NO_ROUTE_DESTINATION"/> -->
        <action application="set" data="continue_on_fail=true"/>
        <action application="hash" data="insert/${domain_name}-call_return/${dialed_extension}/${caller_id_number}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/${dialed_extension}/${uuid}"/>
        <action application="set" data="called_party_callgroup=${user_data(${dialed_extension}@${domain_name} var callgroup)}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/${called_party_callgroup}/${uuid}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/global/${uuid}"/>
        <!--<action application="export" data="nolocal:rtp_secure_media=${user_data(${dialed_extension}@${domain_name} var rtp_secure_media)}"/>-->
        <action application="hash" data="insert/${domain_name}-last_dial/${called_party_callgroup}/${uuid}"/>
        <action application="bridge" data="user/${dialed_extension}@${domain_name}"/>
        <action application="answer"/>
        <action application="sleep" data="1000"/>
        <action application="bridge" data="loopback/app=voicemail:default ${domain_name} ${dialed_extension}"/>
      </condition>
    </extension>				
				]]>
				</screen>
			</section>
			<section>
				<title>禁用外部配置</title>
				<screen>
				<![CDATA[
[root@netkiller ~]# mv /etc/freeswitch/sip_profiles/external.xml /etc/freeswitch/sip_profiles/external.xml.backup 
[root@netkiller ~]# mv /etc/freeswitch/sip_profiles/external-ipv6.xml /etc/freeswitch/sip_profiles/external-ipv6.xml.backup
				]]>
				</screen>
				<screen>
				<![CDATA[
[root@netkiller ~]# docker exec -it freeswitch fs_cli -x "sofia status profile external" 
Invalid Profile!

[root@netkiller ~]# ss -lnt| grep 5080				
				]]>
				</screen>
			</section>
			<section>
				<title>Websocket</title>
				<para>配置 Websocket 证书，使用 certbot 工具可以创建免费 SSL 证书</para>
				<para>合并 Let’s Encrypt 证书到 wss.pem 文件</para>
				<para>Certificate is saved at:
					/etc/letsencrypt/live/netkiller.cn/fullchain.pem</para>
				<para>Key is saved at:
					/etc/letsencrypt/live/netkiller.cn/privkey.pem</para>
				<screen>
				<![CDATA[
[root@netkiller ~]# cat /etc/letsencrypt/live/netkiller.cn/fullchain.pem /etc/letsencrypt/live/netkiller.cn/privkey.pem > /etc/freeswitch/tls/wss.pem
				]]>
				</screen>
				<screen>
				<![CDATA[
[root@netkiller ~]# vim /etc/freeswitch/sip_profiles/internal.xml
<param name="ws-binding"  value=":5066"/>
<param name="wss-binding" value=":7443"/>
				]]>
				</screen>
				<para>检查证书</para>
				<screen>
				<![CDATA[
neo@Mac workspace % openssl s_client -connect pbx.netkiller.cn:7443 > /tmp/test.txt
Connecting to 120.79.201.161
depth=2 C=US, O=Internet Security Research Group, CN=ISRG Root X1
verify return:1
depth=1 C=US, O=Let's Encrypt, CN=E7
verify return:1
depth=0 CN=*.netkiller.cn
verify return:1


neo@Mac workspace % 
neo@Mac workspace % cat /tmp/test.txt 
CONNECTED(00000005)
---
Certificate chain
 0 s:CN=*.netkiller.cn
   i:C=US, O=Let's Encrypt, CN=E7
   a:PKEY: EC, (prime256v1); sigalg: ecdsa-with-SHA384
   v:NotBefore: Feb 10 00:03:11 2026 GMT; NotAfter: May 11 00:03:10 2026 GMT
 1 s:C=US, O=Let's Encrypt, CN=E7
   i:C=US, O=Internet Security Research Group, CN=ISRG Root X1
   a:PKEY: EC, (secp384r1); sigalg: sha256WithRSAEncryption
   v:NotBefore: Mar 13 00:00:00 2024 GMT; NotAfter: Mar 12 23:59:59 2027 GMT
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIDhzCCAw6gAwIBAgISBYDGIz+ODFmShIvoPOFY6yQHMAoGCCqGSM49BAMDMDIx
CzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQDEwJF
NzAeFw0yNjAyMTAwMDAzMTFaFw0yNjA1MTEwMDAzMTBaMBkxFzAVBgNVBAMMDiou
bmV0a2lsbGVyLmNuMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEnEslqbCRqtXc
aTZthfMQ6a5HEfvlRDBJCSWsUBA2ZaZk+t3uNAtpTtcyRnzbyQDv19uESKdJjdfX
6FetkZZEF6OCAhswggIXMA4GA1UdDwEB/wQEAwIHgDAdBgNVHSUEFjAUBggrBgEF
BQcDAQYIKwYBBQUHAwIwDAYDVR0TAQH/BAIwADAdBgNVHQ4EFgQUqo1NperddSTG
v19EejEFi4KbZZIwHwYDVR0jBBgwFoAUrkie3IcdRKBv2qLlYHQEeMKcAIAwMgYI
KwYBBQUHAQEEJjAkMCIGCCsGAQUFBzAChhZodHRwOi8vZTcuaS5sZW5jci5vcmcv
MBkGA1UdEQQSMBCCDioubmV0a2lsbGVyLmNuMBMGA1UdIAQMMAowCAYGZ4EMAQIB
MCwGA1UdHwQlMCMwIaAfoB2GG2h0dHA6Ly9lNy5jLmxlbmNyLm9yZy84LmNybDCC
AQQGCisGAQQB1nkCBAIEgfUEgfIA8AB2AEmcm2neHXzs/DbezYdkprhbrwqHgBnR
VVL76esp3fjDAAABnEURhPYAAAQDAEcwRQIgXdNvyVpWZ19eNM84Hqd0DoJlqcU6
Z584Sj35nYRtc40CIQC8490w4yxsUjQJKZVdoeSNlLduLzs/tmVXIE+PHphL0wB2
AMs49xWJfIShRF9bwd37yW7ymlnNRwppBYWwyxTDFFjnAAABnEURhQgAAAQDAEcw
RQIhANxlZboRKZwSzHs9d6MOspV4vWZGKfEf6CZ2Nyt4O2M+AiA3GD55aFi25DSd
s1r/kZwBpz7i+UPWY0zHy66Qr7bT1jAKBggqhkjOPQQDAwNnADBkAjAmqbMXOD91
4Aoe8C4KljbS67LyD/cDcEzP7DmO/BFXNWB8LfWi2YcdXMW1rmlqNGECME4U91tv
zd+lMc+auF1+dS+RxvJGq46Ddv3aetq/kYRTUWko9/2xPYbpcpKzfGrsEQ==
-----END CERTIFICATE-----
subject=CN=*.netkiller.cn
issuer=C=US, O=Let's Encrypt, CN=E7
---
No client certificate CA names sent
Peer signing digest: SHA256
Peer signature type: ecdsa_secp256r1_sha256
Peer Temp Key: X25519, 253 bits
---
SSL handshake has read 2398 bytes and written 1627 bytes
Verification: OK
---
New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
Protocol: TLSv1.3
Server public key is 256 bit
This TLS version forbids renegotiation.
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 0 (ok)
---
HTTP/1.1 400 Bad Request
Sec-WebSocket-Version: 13

---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: 9C01DBA1BEC52859B5ACB50D9679B2170745410B8D3F4479A9E0BD93B5ACFB27
    Session-ID-ctx: 
    Resumption PSK: 5E56D1354DE5640D683F06A8D5A5BC3860EC9FF190DD71DD84BFD94735A3ECA0F9418D6E308ACCD01F7A1822323FFA2F
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 7200 (seconds)
    TLS session ticket:
    0000 - c6 e4 6e e1 78 48 0b 90-13 7f a5 d5 ee d5 17 92   ..n.xH..........
    0010 - ed e9 2f d1 27 d9 8e 29-d2 02 a3 2c ee 10 20 48   ../.'..)...,.. H
    0020 - d6 7d 88 50 9f 81 e2 ab-85 4e 96 17 b5 42 70 0f   .}.P.....N...Bp.
    0030 - e7 c4 47 64 aa e4 94 60-5d 2a c8 1f 71 bf 47 73   ..Gd...`]*..q.Gs
    0040 - 24 91 31 49 6c ba e3 79-9d 0f 8b 8f 34 c2 6e ac   $.1Il..y....4.n.
    0050 - cc b3 e6 f5 26 ee 68 99-b0 04 94 19 79 8a 71 c8   ....&.h.....y.q.
    0060 - 4b 2b fe 06 42 cc 37 89-7c e7 2a 18 6c d7 bb 36   K+..B.7.|.*.l..6
    0070 - 69 e4 28 4a d9 ac 51 d1-98 04 73 7a 98 19 87 a6   i.(J..Q...sz....
    0080 - e9 ef d3 48 6e c4 7b b0-4d da 27 d4 50 fe 39 ab   ...Hn.{.M.'.P.9.
    0090 - 64 40 f8 e7 6b 27 23 fa-80 06 7f 72 df 58 21 8d   d@..k'#....r.X!.
    00a0 - 40 67 c6 f6 c7 06 9b ca-a1 21 b5 b1 c2 cf af e8   @g.......!......
    00b0 - e9 1a 2f de 94 61 c6 3b-7e 3e d7 e6 90 08 b8 28   ../..a.;~>.....(
    00c0 - 20 31 34 07 64 53 61 5b-8b da 95 37 7f a6 1d de    14.dSa[...7....

    Start Time: 1770698951
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: 48BBF0CAEA2D59EB2F47501D436B5887285B1612A4D0341FF00E82896C0FDC59
    Session-ID-ctx: 
    Resumption PSK: C9018964C38D7A4764FFC0B0A80B38AC7A2969EB61D6180695E5033F3374CA5944D1E74A9E5B91DD177BA5EF47E840D9
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 7200 (seconds)
    TLS session ticket:
    0000 - c6 e4 6e e1 78 48 0b 90-13 7f a5 d5 ee d5 17 92   ..n.xH..........
    0010 - 43 21 fd 01 6b 00 b4 13-c2 dc 72 9b 3c 0f 7c 2c   C!..k.....r.<.|,
    0020 - 13 75 0f 1b e9 7f 19 8e-b8 bb 82 f5 39 f0 c4 9a   .u..........9...
    0030 - 22 d7 bf ee 36 8e e9 e6-09 03 49 4f 13 4a da 9e   "...6.....IO.J..
    0040 - 29 f3 13 3f 31 e5 75 7e-ba 30 38 d0 d9 e9 aa a8   )..?1.u~.08.....
    0050 - 56 32 6a 6e d2 f4 76 d9-94 53 3b e8 8f 22 f3 45   V2jn..v..S;..".E
    0060 - 3f 7f 46 39 0f 01 5e 1e-21 34 ad 77 59 c4 2e e2   ?.F9..^.!4.wY...
    0070 - 69 48 34 bd ef 53 35 20-28 d4 11 a6 f5 a1 75 f9   iH4..S5 (.....u.
    0080 - 13 0b 4b a4 1b 1d b9 4c-97 f2 6d f7 f5 03 59 58   ..K....L..m...YX
    0090 - 12 c2 fb 5c 5b 09 25 37-41 39 62 6f 60 ad 16 93   ...\[.%7A9bo`...
    00a0 - 4d b8 40 26 65 df 8a f0-36 49 1b 14 29 dd fe 24   M.@&e...6I..)..$
    00b0 - 86 1e 22 55 ec 97 c9 17-76 44 40 c5 9a 2a 9e 26   .."U....vD@..*.&
    00c0 - f3 70 5e 19 ee d1 e5 22-73 4b fa 15 89 0e 3c a6   .p^...."sK....<.

    Start Time: 1770698951
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
closed				
				]]>
				</screen>
				<para>若想禁用 Websocket</para>
				<screen>
				<![CDATA[
[root@netkiller ~]# grep verto autoload_configs/modules.conf.xml 
          <!-- <load module="mod_verto"/> -->
          				
[root@netkiller ~]# cat sip_profiles/internal.xml |egrep "5066|7443"
            <!-- <param name="ws-binding"  value=":5066"/> -->
            <!-- <param name="wss-binding" value=":7443"/> -->				
				]]>
				</screen>
				<screen>
				<![CDATA[
[root@netkiller ~]# docker exec -it freeswitch fs_cli -x "sofia status profile internal" 
=================================================================================================
Name                    internal
Domain Name             N/A
Auto-NAT                false
DBName                  sofia_reg_internal
Pres Hosts              pbx.netkiller.cn,172.22.11.164
Dialplan                XML
Context                 public
Challenge Realm         auto_from
RTP-IP                  172.22.11.164
Ext-RTP-IP              120.79.201.161
SIP-IP                  172.22.11.164
Ext-SIP-IP              120.79.201.161
URL                     sip:mod_sofia@120.79.201.161:5061
BIND-URL                sip:mod_sofia@120.79.201.161:5061;maddr=172.22.11.164;transport=udp,tcp
HOLD-MUSIC              local_stream://moh
OUTBOUND-PROXY          N/A
CODECS IN               OPUS,G722,PCMU,PCMA,H264,VP8
CODECS OUT              OPUS,G722,PCMU,PCMA,H264,VP8
TEL-EVENT               101
DTMF-MODE               rfc2833
CNG                     13
SESSION-TO              0
MAX-DIALOG              0
MAX-RECV-RPS            1000
NOMEDIA                 false
LATE-NEG                true
PROXY-MEDIA             false
AGGRESSIVENAT           false
CALLS-IN                2
FAILED-CALLS-IN         0
CALLS-OUT               1
FAILED-CALLS-OUT        0
REGISTRATIONS           9				
				]]>
				</screen>
			</section>
		</section>
		<section id="freeswitch.docker.fs_cli">
			<title>管理 freeswitch</title>
			<screen>
			<![CDATA[
# 解除模块
docker exec -it freeswitch fs_cli -x "unload mod_signalwire"
			
# 查看所有SIP profile的状态
docker exec -it freeswitch fs_cli -x "sofia status"

# 查看某个profile的详细信息（如internal或external）
docker exec -it freeswitch fs_cli -x "sofia status profile internal"

# 查看 internal profile 下的所有注册用户信息（已注册的终端列表）
docker exec -it freeswitch fs_cli -x "sofia status profile internal reg"

# 重新加载XML配置（包括用户、拨号计划等）
docker exec -it freeswitch fs_cli -x "reloadxml"

# 列出当前所有正在运行的会议室及相关信息
docker exec -it freeswitch fs_cli -x "conference list"

# 挂断指定UUID的通话
docker exec -it freeswitch fs_cli -x "uuid_kill <uuid>"

# 显示当前所有活动的通道（channels），包括呼叫详情
docker exec -it freeswitch fs_cli -x "show channels"

# 查看指定 UUID 的通道详细信息，UUID 是通话的唯一标识符
docker exec -it freeswitch fs_cli -x "uuid_dump 44e97f0b-bc3c-41d8-9929-936a890c3cb4"

# 使用 Lua 脚本 dissolve_conference.lua 解散会议室，参数是会议室ID和发起者IP（这里示例是会议室12345，IP 154.11.80.119）
docker exec -it freeswitch fs_cli -x "luarun dissolve_conference.lua 12345-154.11.80.119"			
			]]>
			</screen>
			<screen>
			<![CDATA[
[root@testing default]# docker exec -it freeswitch fs_cli -x "sofia status"
                     Name          Type                                       Data      State
=================================================================================================
            external-ipv6       profile   sip:mod_sofia@[2408:4003:1150:2600:5ec0:2ed4:4199:547e]:5080  RUNNING (0)
            172.22.11.164         alias                                   internal      ALIASED
                 external       profile          sip:mod_sofia@120.79.201.161:5080      RUNNING (0)
    external::example.com       gateway                    sip:joeuser@example.com      NOREG
            internal-ipv6       profile   sip:mod_sofia@[2408:4003:1150:2600:5ec0:2ed4:4199:547e]:5060  RUNNING (0)
                 internal       profile          sip:mod_sofia@120.79.201.161:5060      RUNNING (0)
=================================================================================================
4 profiles 1 alias
			]]>
			</screen>
			<para></para>
			<screen>
			<![CDATA[
[root@netkiller ~]# docker exec -it freeswitch fs_cli -x "sofia status profile internal"
=================================================================================================
Name                    internal
Domain Name             N/A
Auto-NAT                false
DBName                  sofia_reg_internal
Pres Hosts              pbx.netkiller.cn,172.22.11.164
Dialplan                XML
Context                 public
Challenge Realm         auto_from
RTP-IP                  172.22.11.164
Ext-RTP-IP              120.79.201.161
SIP-IP                  172.22.11.164
Ext-SIP-IP              120.79.201.161
URL                     sip:mod_sofia@120.79.201.161:5060
BIND-URL                sip:mod_sofia@120.79.201.161:5060;maddr=172.22.11.164;transport=udp,tcp
TLS-URL                 sip:mod_sofia@120.79.201.161:5061
TLS-BIND-URL            sips:mod_sofia@120.79.201.161:5061;maddr=172.22.11.164;transport=tls
WS-BIND-URL             sip:mod_sofia@172.22.11.164:5066;transport=ws
WSS-BIND-URL            sips:mod_sofia@172.22.11.164:7443;transport=wss
HOLD-MUSIC              local_stream://moh
OUTBOUND-PROXY          N/A
CODECS IN               OPUS,G722,PCMU,PCMA,H264,VP8
CODECS OUT              OPUS,G722,PCMU,PCMA,H264,VP8
TEL-EVENT               101
DTMF-MODE               rfc2833
CNG                     13
SESSION-TO              0
MAX-DIALOG              0
MAX-RECV-RPS            1000
NOMEDIA                 false
LATE-NEG                true
PROXY-MEDIA             false
AGGRESSIVENAT           false
CALLS-IN                43
FAILED-CALLS-IN         43
CALLS-OUT               0
FAILED-CALLS-OUT        0
REGISTRATIONS           4			
			]]>
			</screen>
			<para>查看注册情况</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# docker exec -it freeswitch fs_cli -x "sofia status profile internal reg"

Registrations:
=================================================================================================
Call-ID:        4640d1c4-68b2ec4e@192.168.23.21
User:           1720@pbx.netkiller.cn
Contact:        "1720" <sip:1720@100.64.56.237:65477;fs_nat=yes;fs_path=sip%3A1720%40183.14.132.54%3A17945>
Agent:          Linksys/PAP2T-5.1.6(LS)
Status:         Registered(UDP-NAT)(unknown) EXP(2026-02-10 03:17:18) EXPSECS(860)
Ping-Status:    Reachable
Ping-Time:      0.00
Host:           testing
IP:             183.14.132.54
Port:           17945
Auth-User:      1720
Auth-Realm:     pbx.netkiller.cn
MWI-Account:    1720@pbx.netkiller.cn

Call-ID:        shfboftsbn9tnfnmk1ivib
User:           4600442@pbx.netkiller.cn
Contact:        "" <sip:0ia9s501@qkr364fkldvi.invalid;transport=ws;fs_nat=yes;fs_path=sip%3A0ia9s501%40116.24.64.62%3A60193%3Btransport%3Dwss>
Agent:          JsSIP 3.13.4
Status:         Registered(WSS-NAT)(unknown) EXP(2026-02-10 03:10:22) EXPSECS(444)
Ping-Status:    Reachable
Ping-Time:      0.00
Host:           testing
IP:             116.24.64.62
Port:           60193
Auth-User:      4600442
Auth-Realm:     pbx.netkiller.cn
MWI-Account:    4600442@pbx.netkiller.cn

Call-ID:        349CB636C2D53CDC0516A816AA744C0A8FFD08B0
User:           4600441@pbx.netkiller.cn
Contact:        "" <sip:4600441@172.16.0.24:43769;rinstance=402A5B8C;transport=tcp;fs_nat=yes;fs_path=sip%3A4600441%40183.14.29.46%3A34738%3Brinstance%3D402A5B8C%3Btransport%3Dtcp>
Agent:          Groundwire/5.3.6 (build 1431795; Android 8.1.0; arm64-v8a)
Status:         Registered(TCP-NAT)(unknown) EXP(2026-02-10 03:13:57) EXPSECS(659)
Ping-Status:    Reachable
Ping-Time:      0.00
Host:           testing
IP:             183.14.29.46
Port:           34738
Auth-User:      4600441
Auth-Realm:     pbx.netkiller.cn
MWI-Account:    4600441@pbx.netkiller.cn

Total items returned: 3
=================================================================================================			
			]]>
			</screen>
		</section>
	</section>

	<section id="freeswitch.dnf">
		<title>Rocky Linux / AlmiLinux 安装</title>
		<para>注册用户并创建令牌</para>
		<para>
			前往
			<ulink url="https://signalwire.com" />
			注册账号
		</para>

		<para>点击自己头像，选择“Personal Access Tokens” 进入个人访问令牌页面，然后点击“+ Add New”
			创建令牌。
		</para>
		<para>Token Name 处输入令牌名称，然后点击 “Generate Token” 生成令牌。</para>
		<para>PERSONAL ACCESS TOKEN 下面一串字符，就是令牌，请复制出来并保存好。</para>


		<screen>
		<![CDATA[
echo "netkiller" > /etc/yum/vars/signalwireusername
echo "pat_hbpgtYbJHMMS5Wcy868dW1o2" > /etc/yum/vars/signalwiretoken
dnf install -y https://$(< /etc/yum/vars/signalwireusername):$(< /etc/yum/vars/signalwiretoken)@freeswitch.signalwire.com/repo/yum/centos-release/freeswitch-release-repo-0-1.noarch.rpm epel-release
		]]>
		</screen>
		<para>查看相关包</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# dnf search freeswitch
FreeSWITCH Packages for Enterprise Linux 9 - x86_64                                                                                                    174 kB/s | 752 kB     00:04    
FreeSWITCH Packages for Enterprise Linux 9 - x86_64 - Debug                                                                                            168 kB/s | 752 kB     00:04    
FreeSWITCH Packages for Enterprise Linux 9 - x86_64 - Source                                                                                           174 kB/s | 752 kB     00:04    
========================================================================= Name & Summary Matched: freeswitch ==========================================================================
freeswitch.src : FreeSWITCH open source telephony platform
freeswitch.x86_64 : FreeSWITCH open source telephony platform
freeswitch-application-abstraction.x86_64 : FreeSWITCH mod_abstraction
freeswitch-application-avmd.x86_64 : FreeSWITCH voicemail detector
freeswitch-application-blacklist.x86_64 : FreeSWITCH blacklist module
freeswitch-application-callcenter.x86_64 : FreeSWITCH mod_callcenter Call Queuing Application
freeswitch-application-cidlookup.x86_64 : FreeSWITCH mod_cidlookup
freeswitch-application-conference.x86_64 : FreeSWITCH mod_conference
freeswitch-application-curl.x86_64 : FreeSWITCH mod_curl
freeswitch-application-db.x86_64 : FreeSWITCH mod_db
freeswitch-application-directory.x86_64 : FreeSWITCH mod_directory
freeswitch-application-distributor.x86_64 : FreeSWITCH mod_distributor
freeswitch-application-easyroute.x86_64 : FreeSWITCH mod_easyroute
freeswitch-application-enum.x86_64 : FreeSWITCH mod_enum
freeswitch-application-esf.x86_64 : FreeSWITCH mod_esf
freeswitch-application-expr.x86_64 : FreeSWITCH mod_expr
freeswitch-application-fifo.x86_64 : FreeSWITCH mod_fifo
freeswitch-application-fsk.x86_64 : FreeSWITCH mod_fsk
freeswitch-application-fsv.x86_64 : FreeSWITCH mod_fsv
freeswitch-application-hash.x86_64 : FreeSWITCH mod_hash
freeswitch-application-httapi.x86_64 : FreeSWITCH mod_httapi
freeswitch-application-http-cache.x86_64 : FreeSWITCH mod_http_cache
freeswitch-application-lcr.x86_64 : FreeSWITCH mod_lcr
freeswitch-application-limit.x86_64 : FreeSWITCH mod_limit
freeswitch-application-memcache.x86_64 : FreeSWITCH mod_memcache
freeswitch-application-mongo.x86_64 : FreeSWITCH mod_mongo
freeswitch-application-nibblebill.x86_64 : FreeSWITCH mod_nibblebill
freeswitch-application-rad_auth.x86_64 : FreeSWITCH mod_rad_auth
freeswitch-application-redis.x86_64 : FreeSWITCH mod_redis
freeswitch-application-rss.x86_64 : FreeSWITCH mod_rss
freeswitch-application-signalwire.x86_64 : FreeSWITCH mod_signalwire
freeswitch-application-sms.x86_64 : FreeSWITCH mod_sms
freeswitch-application-snapshot.x86_64 : FreeSWITCH mod_snapshot
freeswitch-application-snom.x86_64 : FreeSWITCH mod_snom
freeswitch-application-soundtouch.x86_64 : FreeSWITCH mod_soundtouch
freeswitch-application-spy.x86_64 : FreeSWITCH mod_spy
freeswitch-application-stress.x86_64 : FreeSWITCH mod_stress
freeswitch-application-translate.x86_64 : FreeSWITCH mod_translate
freeswitch-application-valet_parking.x86_64 : FreeSWITCH mod_valet_parking
freeswitch-application-video_filter.x86_64 : FreeSWITCH video filter bugs
freeswitch-application-voicemail.x86_64 : FreeSWITCH mod_voicemail
freeswitch-application-voicemail-ivr.x86_64 : FreeSWITCH mod_voicemail_ivr
freeswitch-asrtts-flite.x86_64 : FreeSWITCH mod_flite
freeswitch-asrtts-pocketsphinx.x86_64 : FreeSWITCH mod_pocketsphinx
freeswitch-asrtts-tts-commandline.x86_64 : FreeSWITCH mod_tts_commandline
freeswitch-asrtts-unimrcp.x86_64 : FreeSWITCH mod_unimrcp
freeswitch-codec-bv.x86_64 : BroadVoice16 and BroadVoice32 WideBand Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-codec2.x86_64 : Codec2 Narrow Band Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-h26x.x86_64 : H.263/H.264 Video Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-ilbc.x86_64 : iLCB Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-isac.x86_64 : iSAC Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-mp4v.x86_64 : MP4V Video Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-opus.x86_64 : Opus Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-passthru-amr.x86_64 : Pass-through AMR Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-passthru-amrwb.x86_64 : Pass-through AMR WideBand Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-passthru-g723_1.x86_64 : Pass-through g723.1 Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-passthru-g729.x86_64 : Pass-through g729 Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-silk.x86_64 : Silk Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-siren.x86_64 : Siren Codec support for FreeSWITCH open source telephony platform
freeswitch-codec-theora.x86_64 : Theora Video Codec support for FreeSWITCH open source telephony platform
freeswitch-config-vanilla.x86_64 : Basic vanilla config set for the FreeSWITCH Open Source telephone platform.
freeswitch-database-mariadb.x86_64 : MariaDB native support for FreeSWITCH
freeswitch-database-pgsql.x86_64 : PostgreSQL native support for FreeSWITCH
freeswitch-debuginfo.x86_64 : Debug information for package freeswitch
freeswitch-devel.x86_64 : Development package for FreeSWITCH open source telephony platform
freeswitch-endpoint-dingaling.x86_64 : Generic XMPP support for FreeSWITCH open source telephony platform
freeswitch-endpoint-portaudio.x86_64 : PortAudio endpoint support for FreeSWITCH open source telephony platform
freeswitch-endpoint-rtc.x86_64 : Verto endpoint support for FreeSWITCH open source telephony platform
freeswitch-endpoint-rtmp.x86_64 : RTPM Endpoint support for FreeSWITCH open source telephony platform
freeswitch-endpoint-skinny.x86_64 : Skinny/SCCP endpoint support for FreeSWITCH open source telephony platform
freeswitch-endpoint-verto.x86_64 : Verto endpoint support for FreeSWITCH open source telephony platform
freeswitch-event-cdr-mongodb.x86_64 : MongoDB CDR Logger for the FreeSWITCH open source telephony platform
freeswitch-event-cdr-pg-csv.x86_64 : PostgreSQL CDR Logger for the FreeSWITCH open source telephony platform
freeswitch-event-cdr-sqlite.x86_64 : SQLite CDR Logger for the FreeSWITCH open source telephony platform
freeswitch-event-erlang-event.x86_64 : Erlang Event Module for the FreeSWITCH open source telephony platform
freeswitch-event-format-cdr.x86_64 : JSON and XML Logger for the FreeSWITCH open source telephony platform
freeswitch-event-json-cdr.x86_64 : JSON CDR Logger for the FreeSWITCH open source telephony platform
freeswitch-event-multicast.x86_64 : Multicast Event System for the FreeSWITCH open source telephony platform
freeswitch-event-radius-cdr.x86_64 : RADIUS Logger for the FreeSWITCH open source telephony platform
freeswitch-event-rayo.x86_64 : Rayo (XMPP 3PCC) server for the FreeSWITCH open source telephony platform
freeswitch-event-snmp.x86_64 : SNMP stats reporter for the FreeSWITCH open source telephony platform
freeswitch-format-local-stream.x86_64 : Local File Streamer for the FreeSWITCH open source telephony platform
freeswitch-format-mod-shout.x86_64 : Implements Media Steaming from arbitrary shell commands for the FreeSWITCH open source telephony platform
freeswitch-format-native-file.x86_64 : Native Media File support for the FreeSWITCH open source telephony platform
freeswitch-format-portaudio-stream.x86_64 : PortAudio Media Steam support for the FreeSWITCH open source telephony platform
freeswitch-format-shell-stream.x86_64 : Implements Media Steaming from arbitrary shell commands for the FreeSWITCH open source telephony platform
freeswitch-format-ssml.x86_64 : Adds Speech Synthesis Markup Language (SSML) parser format for the FreeSWITCH open source telephony platform
freeswitch-format-tone-stream.x86_64 : Implements TGML Tone Generation for the FreeSWITCH open source telephony platform
freeswitch-freetdm.x86_64 : Provides a unified interface to hardware TDM cards and ss7 stacks for FreeSWITCH
freeswitch-kazoo.x86_64 : Kazoo Module for the FreeSWITCH open source telephony platform
freeswitch-lang-de.x86_64 : Provides german language dependend modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lang-en.x86_64 : Provides english language dependent modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lang-es.x86_64 : Provides Spanish language dependend modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lang-fr.x86_64 : Provides french language dependend modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lang-he.x86_64 : Provides hebrew language dependend modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lang-pt.x86_64 : Provides Portuguese language dependend modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lang-ru.x86_64 : Provides russian language dependent modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lang-sv.x86_64 : Provides Swedish language dependend modules and speech config for the FreeSWITCH Open Source telephone platform.
freeswitch-lua.x86_64 : Lua support for the FreeSWITCH open source telephony platform
freeswitch-perl.x86_64 : Perl support for the FreeSWITCH open source telephony platform
freeswitch-python.x86_64 : Python support for the FreeSWITCH open source telephony platform
freeswitch-release-repo.noarch : FreeSWITCH Packages for Enterprise Linux repository configuration
freeswitch-sounds-en-ca-june.noarch : FreeSWITCH fr-CA June prompts
freeswitch-sounds-en-ca-june-16000.noarch : FreeSWITCH 16kHz fr CA June prompts
freeswitch-sounds-en-ca-june-32000.noarch : FreeSWITCH 32kHz fr CA June prompts
freeswitch-sounds-en-ca-june-48000.noarch : FreeSWITCH 48kHz fr CA June prompts
freeswitch-sounds-en-ca-june-8000.noarch : FreeSWITCH 8kHz fr CA June prompts
freeswitch-sounds-en-ca-june-all.noarch : FreeSWITCH fr CA June prompts
freeswitch-sounds-en-us-allison.noarch : FreeSWITCH en-us Allison prompts
freeswitch-sounds-en-us-allison-16000.noarch : FreeSWITCH 16kHz en-us Allison prompts
freeswitch-sounds-en-us-allison-32000.noarch : FreeSWITCH 32kHz en-us Allison prompts
freeswitch-sounds-en-us-allison-48000.noarch : FreeSWITCH 48kHz en-us Allison prompts
freeswitch-sounds-en-us-allison-8000.noarch : FreeSWITCH 8kHz en-us Allison prompts
freeswitch-sounds-en-us-allison-all.noarch : FreeSWITCH en-us Allison prompts
freeswitch-sounds-en-us-callie.noarch : FreeSWITCH en-us Callie prompts
freeswitch-sounds-en-us-callie-16000.noarch : FreeSWITCH 16kHz en-us Callie prompts
freeswitch-sounds-en-us-callie-32000.noarch : FreeSWITCH 32kHz en-us Callie prompts
freeswitch-sounds-en-us-callie-48000.noarch : FreeSWITCH 48kHz en-us Callie prompts
freeswitch-sounds-en-us-callie-8000.noarch : FreeSWITCH 8kHz en-us Callie prompts
freeswitch-sounds-en-us-callie-all.noarch : FreeSWITCH en-us Callie prompts
freeswitch-sounds-fr-ca-june.noarch : FreeSWITCH fr-CA June prompts
freeswitch-sounds-fr-ca-june-16000.noarch : FreeSWITCH 16kHz fr CA June prompts
freeswitch-sounds-fr-ca-june-32000.noarch : FreeSWITCH 32kHz fr CA June prompts
freeswitch-sounds-fr-ca-june-48000.noarch : FreeSWITCH 48kHz fr CA June prompts
freeswitch-sounds-fr-ca-june-8000.noarch : FreeSWITCH 8kHz fr CA June prompts
freeswitch-sounds-fr-ca-june-all.noarch : FreeSWITCH fr CA June prompts
freeswitch-sounds-music.noarch : FreeSWITCH Music on Hold soundfiles
freeswitch-sounds-music-16000.noarch : FreeSWITCH 16kHz Music On Hold soundfiles
freeswitch-sounds-music-32000.noarch : FreeSWITCH 32kHz Music On Hold soundfiles
freeswitch-sounds-music-48000.noarch : FreeSWITCH 48kHz Music On Hold soundfiles
freeswitch-sounds-music-8000.noarch : FreeSWITCH 8kHz Music On Hold soundfiles
freeswitch-sounds-pt-BR-karina.noarch : FreeSWITCH pt-BR Karina prompts
freeswitch-sounds-pt-BR-karina-16000.noarch : FreeSWITCH 16kHz fr BR Karina prompts
freeswitch-sounds-pt-BR-karina-32000.noarch : FreeSWITCH 32kHz fr BR Karina prompts
freeswitch-sounds-pt-BR-karina-48000.noarch : FreeSWITCH 48kHz fr BR Karina prompts
freeswitch-sounds-pt-BR-karina-8000.noarch : FreeSWITCH 8kHz fr BR Karina prompts
freeswitch-sounds-pt-BR-karina-all.noarch : FreeSWITCH fr BR Karina prompts
freeswitch-sounds-ru-RU-elena.noarch : FreeSWITCH ru-RU Elena prompts
freeswitch-sounds-ru-RU-elena-16000.noarch : FreeSWITCH 16kHz ru-RU Elena prompts
freeswitch-sounds-ru-RU-elena-32000.noarch : FreeSWITCH 32kHz ru-RU Elena prompts
freeswitch-sounds-ru-RU-elena-48000.noarch : FreeSWITCH 48kHz ru-RU Elena prompts
freeswitch-sounds-ru-RU-elena-8000.noarch : FreeSWITCH 8kHz ru-RU Elena prompts
freeswitch-sounds-ru-RU-elena-all.noarch : FreeSWITCH ru-RU Elena prompts
freeswitch-sounds-sv-se-jakob.noarch : FreeSWITCH sv-se Jakob prompts
freeswitch-sounds-sv-se-jakob-16000.noarch : FreeSWITCH 16kHz sv-se jakob prompts
freeswitch-sounds-sv-se-jakob-32000.noarch : FreeSWITCH 32kHz sv-se jakob prompts
freeswitch-sounds-sv-se-jakob-48000.noarch : FreeSWITCH 48kHz sv-se jakob prompts
freeswitch-sounds-sv-se-jakob-8000.noarch : FreeSWITCH 8kHz sv-se jakob prompts
freeswitch-sounds-sv-se-jakob-all.noarch : FreeSWITCH sv-se jakob prompts
freeswitch-timer-posix.x86_64 : Provides posix timer for the FreeSWITCH Open Source telephone platform.
freeswitch-xml-cdr.x86_64 : Provides XML CDR interface for the FreeSWITCH Open Source telephone platform.
freeswitch-xml-curl.x86_64 : Provides XML Curl interface for the FreeSWITCH Open Source telephone platform.
============================================================================== Name Matched: freeswitch ===============================================================================
freeswitch-format-opusfile.x86_64 : Plays Opus encoded files
freeswitch-logger-graylog2.x86_64 : GELF logger for Graylog2 and Logstash
============================================================================= Summary Matched: freeswitch =============================================================================
perl-ESL.x86_64 : The Perl ESL module allows for native interaction with FreeSWITCH over the event socket interface.
python-ESL.x86_64 : The Python ESL module allows for native interaction with FreeSWITCH over the event socket interface.		
		]]>
		</screen>
		<para>查看版本信息</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# dnf info freeswitch
Last metadata expiration check: 0:03:19 ago on Sat 05 Apr 2025 07:50:56 AM CST.
Available Packages
Name         : freeswitch
Version      : 1.10.11.release.18
Release      : 1.el7
Architecture : src
Size         : 59 M
Source       : None
Repository   : freeswitch
Summary      : FreeSWITCH open source telephony platform
URL          : http://www.freeswitch.org/
License      : MPL1.1
Description  : FreeSWITCH is an open source telephony platform designed to facilitate the creation of voice
             : and chat driven products scaling from a soft-phone up to a soft-switch.  It can be used as a
             : simple switching engine, a media gateway or a media server to host IVR applications using
             : simple scripts or XML to control the callflow.
             : 
             : We support various communication technologies such as SIP, H.323 and GoogleTalk making
             : it easy to interface with other open source PBX systems such as sipX, OpenPBX, Bayonne, YATE or Asterisk.
             : 
             : We also support both wide and narrow band codecs making it an ideal solution to bridge legacy
             : devices to the future. The voice channels and the conference bridge module all can operate
             : at 8, 16 or 32 kilohertz and can bridge channels of different rates.
             : 
             : FreeSWITCH runs on several operating systems including Windows, Max OS X, Linux, BSD and Solaris
             : on both 32 and 64 bit platforms.
             : 
             : Our developers are heavily involved in open source and have donated code and other resources to
             : other telephony projects including sipXecs, OpenSER, Asterisk, CodeWeaver and OpenPBX.

Name         : freeswitch
Version      : 1.10.11.release.18
Release      : 1.el7
Architecture : src
Size         : 59 M
Source       : None
Repository   : freeswitch-debuginfo
Summary      : FreeSWITCH open source telephony platform
URL          : http://www.freeswitch.org/
License      : MPL1.1
Description  : FreeSWITCH is an open source telephony platform designed to facilitate the creation of voice
             : and chat driven products scaling from a soft-phone up to a soft-switch.  It can be used as a
             : simple switching engine, a media gateway or a media server to host IVR applications using
             : simple scripts or XML to control the callflow.
             : 
             : We support various communication technologies such as SIP, H.323 and GoogleTalk making
             : it easy to interface with other open source PBX systems such as sipX, OpenPBX, Bayonne, YATE or Asterisk.
             : 
             : We also support both wide and narrow band codecs making it an ideal solution to bridge legacy
             : devices to the future. The voice channels and the conference bridge module all can operate
             : at 8, 16 or 32 kilohertz and can bridge channels of different rates.
             : 
             : FreeSWITCH runs on several operating systems including Windows, Max OS X, Linux, BSD and Solaris
             : on both 32 and 64 bit platforms.
             : 
             : Our developers are heavily involved in open source and have donated code and other resources to
             : other telephony projects including sipXecs, OpenSER, Asterisk, CodeWeaver and OpenPBX.

Name         : freeswitch
Version      : 1.10.11.release.18
Release      : 1.el7
Architecture : src
Size         : 59 M
Source       : None
Repository   : freeswitch-source
Summary      : FreeSWITCH open source telephony platform
URL          : http://www.freeswitch.org/
License      : MPL1.1
Description  : FreeSWITCH is an open source telephony platform designed to facilitate the creation of voice
             : and chat driven products scaling from a soft-phone up to a soft-switch.  It can be used as a
             : simple switching engine, a media gateway or a media server to host IVR applications using
             : simple scripts or XML to control the callflow.
             : 
             : We support various communication technologies such as SIP, H.323 and GoogleTalk making
             : it easy to interface with other open source PBX systems such as sipX, OpenPBX, Bayonne, YATE or Asterisk.
             : 
             : We also support both wide and narrow band codecs making it an ideal solution to bridge legacy
             : devices to the future. The voice channels and the conference bridge module all can operate
             : at 8, 16 or 32 kilohertz and can bridge channels of different rates.
             : 
             : FreeSWITCH runs on several operating systems including Windows, Max OS X, Linux, BSD and Solaris
             : on both 32 and 64 bit platforms.
             : 
             : Our developers are heavily involved in open source and have donated code and other resources to
             : other telephony projects including sipXecs, OpenSER, Asterisk, CodeWeaver and OpenPBX.

Name         : freeswitch
Version      : 1.10.11.release.18
Release      : 1.el7
Architecture : x86_64
Size         : 3.2 M
Source       : freeswitch-1.10.11.release.18-1.el7.src.rpm
Repository   : freeswitch
Summary      : FreeSWITCH open source telephony platform
URL          : http://www.freeswitch.org/
License      : MPL1.1
Description  : FreeSWITCH is an open source telephony platform designed to facilitate the creation of voice
             : and chat driven products scaling from a soft-phone up to a soft-switch.  It can be used as a
             : simple switching engine, a media gateway or a media server to host IVR applications using
             : simple scripts or XML to control the callflow.
             : 
             : We support various communication technologies such as SIP, H.323 and GoogleTalk making
             : it easy to interface with other open source PBX systems such as sipX, OpenPBX, Bayonne, YATE or Asterisk.
             : 
             : We also support both wide and narrow band codecs making it an ideal solution to bridge legacy
             : devices to the future. The voice channels and the conference bridge module all can operate
             : at 8, 16 or 32 kilohertz and can bridge channels of different rates.
             : 
             : FreeSWITCH runs on several operating systems including Windows, Max OS X, Linux, BSD and Solaris
             : on both 32 and 64 bit platforms.
             : 
             : Our developers are heavily involved in open source and have donated code and other resources to
             : other telephony projects including sipXecs, OpenSER, Asterisk, CodeWeaver and OpenPBX.

Name         : freeswitch
Version      : 1.10.11.release.18
Release      : 1.el7
Architecture : x86_64
Size         : 3.2 M
Source       : freeswitch-1.10.11.release.18-1.el7.src.rpm
Repository   : freeswitch-debuginfo
Summary      : FreeSWITCH open source telephony platform
URL          : http://www.freeswitch.org/
License      : MPL1.1
Description  : FreeSWITCH is an open source telephony platform designed to facilitate the creation of voice
             : and chat driven products scaling from a soft-phone up to a soft-switch.  It can be used as a
             : simple switching engine, a media gateway or a media server to host IVR applications using
             : simple scripts or XML to control the callflow.
             : 
             : We support various communication technologies such as SIP, H.323 and GoogleTalk making
             : it easy to interface with other open source PBX systems such as sipX, OpenPBX, Bayonne, YATE or Asterisk.
             : 
             : We also support both wide and narrow band codecs making it an ideal solution to bridge legacy
             : devices to the future. The voice channels and the conference bridge module all can operate
             : at 8, 16 or 32 kilohertz and can bridge channels of different rates.
             : 
             : FreeSWITCH runs on several operating systems including Windows, Max OS X, Linux, BSD and Solaris
             : on both 32 and 64 bit platforms.
             : 
             : Our developers are heavily involved in open source and have donated code and other resources to
             : other telephony projects including sipXecs, OpenSER, Asterisk, CodeWeaver and OpenPBX.

Name         : freeswitch
Version      : 1.10.11.release.18
Release      : 1.el7
Architecture : x86_64
Size         : 3.2 M
Source       : freeswitch-1.10.11.release.18-1.el7.src.rpm
Repository   : freeswitch-source
Summary      : FreeSWITCH open source telephony platform
URL          : http://www.freeswitch.org/
License      : MPL1.1
Description  : FreeSWITCH is an open source telephony platform designed to facilitate the creation of voice
             : and chat driven products scaling from a soft-phone up to a soft-switch.  It can be used as a
             : simple switching engine, a media gateway or a media server to host IVR applications using
             : simple scripts or XML to control the callflow.
             : 
             : We support various communication technologies such as SIP, H.323 and GoogleTalk making
             : it easy to interface with other open source PBX systems such as sipX, OpenPBX, Bayonne, YATE or Asterisk.
             : 
             : We also support both wide and narrow band codecs making it an ideal solution to bridge legacy
             : devices to the future. The voice channels and the conference bridge module all can operate
             : at 8, 16 or 32 kilohertz and can bridge channels of different rates.
             : 
             : FreeSWITCH runs on several operating systems including Windows, Max OS X, Linux, BSD and Solaris
             : on both 32 and 64 bit platforms.
             : 
             : Our developers are heavily involved in open source and have donated code and other resources to
             : other telephony projects including sipXecs, OpenSER, Asterisk, CodeWeaver and OpenPBX.		
		]]>
		</screen>
		<para>安装 freeswitch</para>
		<para>
			安装 compat-openssl10
			<ulink url="https://pkgs.org/download/compat-openssl10" />
		</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# dnf install -y https://pkgs.sysadmins.ws/el9/base/x86_64/compat-openssl10-1.0.2u-1.el9.x86_64.rpm
[root@netkiller ~]# dnf install -y https://repo.almalinux.org/almalinux/9/CRB/x86_64/os/Packages/libmemcached-awesome-1.1.0-12.el9.x86_64.rpm
[root@netkiller ~]# dnf install -y https://dl.rockylinux.org/pub/rocky/9/AppStream/x86_64/os/Packages/l/ldns-1.7.1-12.el9.x86_64.rpm
[root@netkiller ~]# dnf install -y freeswitch-config-vanilla freeswitch-lang-en freeswitch-sounds-en-us-* freeswitch-sounds-music-* freeswitch-codec-opus freeswitch-lua
		]]>
		</screen>
		<para>启动 freeswitch</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# systemctl enable freeswitch
[root@netkiller ~]# systemctl start freeswitch
[root@netkiller ~]# systemctl status freeswitch
		]]>
		</screen>
	</section>
	<section id="freeswitch.firewall">
		<title>防火墙端口</title>
		<screen>
		<![CDATA[
FireWall Ports  Network Protocol    Application Protocol    Description

1719    UDP H.323 Gatekeeper RAS port
1720    TCP H.323 Call Signaling

3478    UDP STUN service    Used for NAT traversal
3479    UDP STUN service    Used for NAT traversal

5002    TCP MLP protocol server
5003    UDP Neighborhood service

5060    UDP & TCP   SIP UAS Used for SIP signaling (Standard SIP Port, for default Internal Profile)
5070    UDP & TCP   SIP UAS Used for SIP signaling (For default "NAT" Profile)
5080    UDP & TCP   SIP UAS Used for SIP signaling (For default "External" Profile)

8021    TCP ESL Used for mod_event_socket *

16384-32768 UDP RTP/ RTCP multimedia streaming  Used for audio/video data in SIP and other protocols

5066    TCP Websocket   Used for WebRTC
7443    TCP Websocket   Used for WebRTC		
		]]>
		</screen>
		<para>fail2ban 自动拦截恶意注册</para>
		<screen>
		<![CDATA[
firewall-cmd --zone=public --add-port=1719/udp  --permanent
firewall-cmd --zone=public --add-port=1720/tcp  --permanent
firewall-cmd --zone=public --add-port=3478-3479/udp  --permanent
firewall-cmd --zone=public --add-port=5002/tcp  --permanent
firewall-cmd --zone=public --add-port=5003/udp  --permanent
firewall-cmd --zone=public --add-port=5060/udp  --permanent
firewall-cmd --zone=public --add-port=5060/tcp  --permanent
firewall-cmd --zone=public --add-port=5070/udp  --permanent
firewall-cmd --zone=public --add-port=5080/udp  --permanent
firewall-cmd --zone=public --add-port=5006/tcp  --permanent
firewall-cmd --zone=public --add-port=5007/tcp  --permanent
firewall-cmd --zone=public --add-port=5008/tcp  --permanent
firewall-cmd --zone=public --add-port=8021/tcp  --permanent
firewall-cmd --zone=public --add-port=16384-32768/udp  --permanent
firewall-cmd --zone=public --add-port=5066/tcp  --permanent
firewall-cmd --zone=public --add-port=7443/tcp  --permanent
		
		]]>
		</screen>
		<para>重启防火墙</para>
		<screen>
		<![CDATA[
firewall-cmd --reload		
		]]>
		</screen>
		<para>查看已开放的端口</para>
		<screen>
		<![CDATA[
firewall-cmd --list-ports
		]]>
		</screen>
	</section>
	<section id="freeswitch.etc">
		<title>备份 freeswitch 配置文件</title>
		<screen>
		<![CDATA[
cp /etc/freeswitch/vars.xml{,.backup}
cp /etc/freeswitch/sip_profiles/internal.xml{,.backup}
cp /etc/freeswitch/sip_profiles/external.xml{,.backup}
cp /etc/freeswitch/dialplan/default.xml{,.backup}
cp /etc/freeswitch/dialplan/public.xml{,.backup}
		]]>
		</screen>
	</section>
	<section id="vars.xml">
		<title>基本配置 /etc/freeswitch/vars.xml </title>
		<section>
			<title>默认密码</title>

			<screen>
			<![CDATA[
[root@netkiller ~]# cp /etc/freeswitch/vars.xml{,.backup}
			]]>
			</screen>
			<para>随机产生密码</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# randpasswd | cut -c -10
NLYPx9JjSx			
			]]>
			</screen>
			<para>修改默认密码，将 1234 改为</para>
			<screen>
			<![CDATA[
  <X-PRE-PROCESS cmd="set" data="default_password=1234"/>
改为   
  <X-PRE-PROCESS cmd="set" data="default_password=NLYPx9JjSx"/>
			]]>
			</screen>
		</section>
		<section>
			<title>领域</title>
			<para>配置领域</para>
			<screen>
			<![CDATA[
<X-PRE-PROCESS cmd="set" data="domain=sip.netkiller.cn"/>			
			]]>
			</screen>
		</section>
		<section>
			<title>公网IP地址</title>
			<para>配置公网IP地址</para>
			<para>适用场景，公网IP直接在Linux eth0 网卡上配置。</para>
			<screen>
			<![CDATA[
<X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=stun:stun.freeswitch.org"/>
改为
<X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=host:sip.netkiller.cn"/>
或
<X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=IP地址"/>
			]]>
			</screen>
		</section>

		<section>
			<title>NAT 配置</title>
			<para>前面的基本配置，是物理服务器网卡直接配置公网IP地址，很多云主机采用弹性IP机制，将公网IP映射到云主机上。这种模式就需要用到
				NAT
			</para>
			<para>配置方法还是修改 /etc/freeswitch/vars.xml 文件</para>
			<section>
				<title>方案一</title>
				<screen>
					<![CDATA[
<X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=autonat:你的公网IP地址"/>
					]]>
				</screen>
				<para></para>
				<screen>
					<![CDATA[
  <X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=autonat:121.37.25.251"/>
  <X-PRE-PROCESS cmd="stun-set" data="external_sip_ip=autonat:121.37.25.251"/>	
					]]>
				</screen>
			</section>
			<section>
				<title>方案二</title>
				<screen>
					<![CDATA[
<X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=host:你的域名"/>
					]]>
				</screen>
				<para></para>
				<screen>
					<![CDATA[
  <X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=host:sip.netkiller.cn"/>
  <X-PRE-PROCESS cmd="stun-set" data="external_sip_ip=host:sip.netkiller.cn"/>
					]]>
				</screen>
			</section>
			<section>
				<title>方案二</title>
				<screen>
					<![CDATA[
<X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=host:$${domain}"/>
					]]>
				</screen>
				<para></para>
				<screen>
					<![CDATA[
  <X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=host:$${domain}"/>
  <X-PRE-PROCESS cmd="stun-set" data="external_sip_ip=host:$${domain}"/>
					]]>
				</screen>
			</section>
		</section>
		<section>
			<title>编码</title>
			<screen>
			<![CDATA[
  <X-PRE-PROCESS cmd="set" data="global_codec_prefs=OPUS,G722,PCMU,PCMA,H264,VP8"/>
  <X-PRE-PROCESS cmd="set" data="outbound_codec_prefs=OPUS,G722,PCMU,PCMA,H264,VP8"/>
			]]>
			</screen>
		</section>
		<section>
			<title>控制台日志级别</title>
			<screen>
			<![CDATA[
<X-PRE-PROCESS cmd="set" data="console_loglevel=4"/>
或
<X-PRE-PROCESS cmd="set" data="console_loglevel=info"/>
			]]>
			</screen>
		</section>

		<section>
			<para>样本参考</para>
			<example>
				<title>/etc/freeswitch/vars.xml</title>
				<para>这是我的配置仅供参考</para>
				<screen>
				<![CDATA[
[root@netkiller ~]# xmlstarlet ed -d '//comment()' /etc/freeswitch/vars.xml
<?xml version="1.0"?>
<include>
  <X-PRE-PROCESS cmd="set" data="default_password=******"/>
  <X-PRE-PROCESS cmd="set" data="sound_prefix=$${sounds_dir}/en/us/callie"/>
  <X-PRE-PROCESS cmd="set" data="domain=sip.netkiller.com"/>
  <X-PRE-PROCESS cmd="set" data="domain_name=$${domain}"/>
  <X-PRE-PROCESS cmd="set" data="hold_music=local_stream://moh"/>
  <X-PRE-PROCESS cmd="set" data="use_profile=external"/>
  <X-PRE-PROCESS cmd="set" data="rtp_sdes_suites=AEAD_AES_256_GCM_8|AEAD_AES_128_GCM_8|AES_CM_256_HMAC_SHA1_80|AES_CM_192_HMAC_SHA1_80|AES_CM_128_HMAC_SHA1_80|AES_CM_256_HMAC_SHA1_32|AES_CM_192_HMAC_SHA1_32|AES_CM_128_HMAC_SHA1_32|AES_CM_128_NULL_AUTH"/>
  <X-PRE-PROCESS cmd="set" data="global_codec_prefs=OPUS,G722,PCMU,PCMA,H264,VP8"/>
  <X-PRE-PROCESS cmd="set" data="outbound_codec_prefs=OPUS,G722,PCMU,PCMA,H264,VP8"/>
  <X-PRE-PROCESS cmd="set" data="xmpp_client_profile=xmppc"/>
  <X-PRE-PROCESS cmd="set" data="xmpp_server_profile=xmpps"/>
  <X-PRE-PROCESS cmd="set" data="bind_server_ip=auto"/>
  <X-PRE-PROCESS cmd="stun-set" data="external_rtp_ip=autonat:121.37.215.251"/>
  <X-PRE-PROCESS cmd="stun-set" data="external_sip_ip=autonat:121.37.215.251"/>
  <X-PRE-PROCESS cmd="set" data="unroll_loops=true"/>
  <X-PRE-PROCESS cmd="set" data="outbound_caller_name=FreeSWITCH"/>
  <X-PRE-PROCESS cmd="set" data="outbound_caller_id=0000000000"/>
  <X-PRE-PROCESS cmd="set" data="call_debug=false"/>
  <X-PRE-PROCESS cmd="set" data="console_loglevel=info"/>
  <X-PRE-PROCESS cmd="set" data="default_areacode=918"/>
  <X-PRE-PROCESS cmd="set" data="default_country=US"/>
  <X-PRE-PROCESS cmd="set" data="presence_privacy=false"/>
  <X-PRE-PROCESS cmd="set" data="au-ring=%(400,200,383,417);%(400,2000,383,417)"/>
  <X-PRE-PROCESS cmd="set" data="be-ring=%(1000,3000,425)"/>
  <X-PRE-PROCESS cmd="set" data="ca-ring=%(2000,4000,440,480)"/>
  <X-PRE-PROCESS cmd="set" data="cn-ring=%(1000,4000,450)"/>
  <X-PRE-PROCESS cmd="set" data="cy-ring=%(1500,3000,425)"/>
  <X-PRE-PROCESS cmd="set" data="cz-ring=%(1000,4000,425)"/>
  <X-PRE-PROCESS cmd="set" data="de-ring=%(1000,4000,425)"/>
  <X-PRE-PROCESS cmd="set" data="dk-ring=%(1000,4000,425)"/>
  <X-PRE-PROCESS cmd="set" data="dz-ring=%(1500,3500,425)"/>
  <X-PRE-PROCESS cmd="set" data="eg-ring=%(2000,1000,475,375)"/>
  <X-PRE-PROCESS cmd="set" data="es-ring=%(1500,3000,425)"/>
  <X-PRE-PROCESS cmd="set" data="fi-ring=%(1000,4000,425)"/>
  <X-PRE-PROCESS cmd="set" data="fr-ring=%(1500,3500,440)"/>
  <X-PRE-PROCESS cmd="set" data="hk-ring=%(400,200,440,480);%(400,3000,440,480)"/>
  <X-PRE-PROCESS cmd="set" data="hu-ring=%(1250,3750,425)"/>
  <X-PRE-PROCESS cmd="set" data="il-ring=%(1000,3000,400)"/>
  <X-PRE-PROCESS cmd="set" data="in-ring=%(400,200,425,375);%(400,2000,425,375)"/>
  <X-PRE-PROCESS cmd="set" data="jp-ring=%(1000,2000,420,380)"/>
  <X-PRE-PROCESS cmd="set" data="ko-ring=%(1000,2000,440,480)"/>
  <X-PRE-PROCESS cmd="set" data="pk-ring=%(1000,2000,400)"/>
  <X-PRE-PROCESS cmd="set" data="pl-ring=%(1000,4000,425)"/>
  <X-PRE-PROCESS cmd="set" data="ro-ring=%(1850,4150,475,425)"/>
  <X-PRE-PROCESS cmd="set" data="rs-ring=%(1000,4000,425)"/>
  <X-PRE-PROCESS cmd="set" data="ru-ring=%(800,3200,425)"/>
  <X-PRE-PROCESS cmd="set" data="sa-ring=%(1200,4600,425)"/>
  <X-PRE-PROCESS cmd="set" data="tr-ring=%(2000,4000,450)"/>
  <X-PRE-PROCESS cmd="set" data="uk-ring=%(400,200,400,450);%(400,2000,400,450)"/>
  <X-PRE-PROCESS cmd="set" data="us-ring=%(2000,4000,440,480)"/>
  <X-PRE-PROCESS cmd="set" data="bong-ring=v=-7;%(100,0,941.0,1477.0);v=-7;&gt;=2;+=.1;%(1400,0,350,440)"/>
  <X-PRE-PROCESS cmd="set" data="beep=%(1000,0,640)"/>
  <X-PRE-PROCESS cmd="set" data="sit=%(274,0,913.8);%(274,0,1370.6);%(380,0,1776.7)"/>
  <X-PRE-PROCESS cmd="set" data="df_us_ssn=(?!219099999|078051120)(?!666|000|9\d{2})\d{3}(?!00)\d{2}(?!0{4})\d{4}"/>
  <X-PRE-PROCESS cmd="set" data="df_luhn=?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|6(?:011|5[0-9]{2})[0-9]{12}|(?:2131|1800|35\d{3})\d{11}"/>
  <XX-PRE-PROCESS cmd="set" data="digits_dialed_filter=(($${df_luhn})|($${df_us_ssn}))"/>
  <X-PRE-PROCESS cmd="set" data="default_provider=example.com"/>
  <X-PRE-PROCESS cmd="set" data="default_provider_username=joeuser"/>
  <X-PRE-PROCESS cmd="set" data="default_provider_password=password"/>
  <X-PRE-PROCESS cmd="set" data="default_provider_from_domain=example.com"/>
  <X-PRE-PROCESS cmd="set" data="default_provider_register=false"/>
  <X-PRE-PROCESS cmd="set" data="default_provider_contact=5000"/>
  <X-PRE-PROCESS cmd="set" data="sip_tls_version=tlsv1,tlsv1.1,tlsv1.2"/>
  <X-PRE-PROCESS cmd="set" data="sip_tls_ciphers=ALL:!ADH:!LOW:!EXP:!MD5:@STRENGTH"/>
  <X-PRE-PROCESS cmd="set" data="internal_auth_calls=true"/>
  <X-PRE-PROCESS cmd="set" data="internal_sip_port=5060"/>
  <X-PRE-PROCESS cmd="set" data="internal_tls_port=5061"/>
  <X-PRE-PROCESS cmd="set" data="internal_ssl_enable=false"/>
  <X-PRE-PROCESS cmd="set" data="external_auth_calls=false"/>
  <X-PRE-PROCESS cmd="set" data="external_sip_port=5080"/>
  <X-PRE-PROCESS cmd="set" data="external_tls_port=5081"/>
  <X-PRE-PROCESS cmd="set" data="external_ssl_enable=false"/>
  <X-PRE-PROCESS cmd="set" data="rtp_video_max_bandwidth_in=3mb"/>
  <X-PRE-PROCESS cmd="set" data="rtp_video_max_bandwidth_out=3mb"/>
  <X-PRE-PROCESS cmd="set" data="suppress_cng=true"/>
  <X-PRE-PROCESS cmd="set" data="rtp_liberal_dtmf=true"/>
  <X-PRE-PROCESS cmd="set" data="video_mute_png=$${images_dir}/default-mute.png"/>
  <X-PRE-PROCESS cmd="set" data="video_no_avatar_png=$${images_dir}/default-avatar.png"/>
</include>
				]]>
				</screen>
			</example>
		</section>
	</section>

	<section id="freeswitch.sip_profiles">
		<title>配置 NAT</title>
		<para>通常在 /etc/freeswitch/vars.xml 中配置，在 internal.xml 和 external.xml
			中通过变量引用
		</para>
		<screen>
			<![CDATA[
[root@netkiller ~]# cp /etc/freeswitch/sip_profiles/internal.xml{,.backup}
[root@netkiller ~]# cp /etc/freeswitch/sip_profiles/external.xml{,.backup}
[root@netkiller ~]# cp /etc/freeswitch/sip_profiles/internal-ipv6.xml{,.backup}
[root@netkiller ~]# cp /etc/freeswitch/sip_profiles/external-ipv6.xml{,.backup}
			]]>
		</screen>
		<para>NAT 配置 172.16.0.10 替换成公网 IP 地址</para>
		<screen>
			<![CDATA[
[root@netkiller ~]# vim /etc/freeswitch/sip_profiles/internal.xml
    <param name="ext-rtp-ip" value="$${external_rtp_ip}"/>
    <param name="ext-sip-ip" value="$${external_sip_ip}"/>
改为
	<param name="ext-rtp-ip" value="autonat:172.16.0.10"/>
	<param name="ext-sip-ip" value="autonat:172.16.0.10"/>		
	
			]]>
		</screen>
		<para></para>
		<screen>
			<![CDATA[
[root@netkiller ~]# vim /etc/freeswitch/sip_profiles/external.xml
    <param name="ext-rtp-ip" value="$${external_rtp_ip}"/>
    <param name="ext-sip-ip" value="$${external_sip_ip}"/>
改为
	<param name="ext-rtp-ip" value="autonat:172.16.0.10"/>
	<param name="ext-sip-ip" value="autonat:172.16.0.10"/>    			
			]]>
		</screen>
		<section>
			<title>旁路模式</title>
			<para>配置 inbound-bypass-media 可以开启旁路模式，在此模式 下FreeSWITCH 只负责 SIP
				信令交换，两个 endpoint 话机 RIP 语音通信是点对点方式。这样比较节省流量，但是国内网络复杂，层层 NAT
				常常出现局域网正常，部署到广域网就会失败，现象是拨通之后没有语音。
			</para>
			<screen>
				<![CDATA[
[root@netkiller ~]# grep -r 'inbound-bypass-media' /etc/freeswitch/sip_profiles/internal.xml
    <!--<param name="inbound-bypass-media" value="true"/>-->	
				]]>
			</screen>
		</section>
		<section>
			<title>启用 100rel</title>
			<screen>
				<![CDATA[
[root@netkiller ~]# grep 100rel /etc/freeswitch/sip_profiles/internal.xml
        There are known issues (asserts and segfaults) when 100rel is enabled.
        It is not recommended to enable 100rel at this time.
    <!--<param name="enable-100rel" value="true"/>-->

[root@netkiller ~]# vim /etc/freeswitch/sip_profiles/internal.xml

[root@netkiller ~]# systemctl restart  freeswitch

[root@netkiller ~]# grep 100rel /etc/freeswitch/sip_profiles/internal.xml
        There are known issues (asserts and segfaults) when 100rel is enabled.
        It is not recommended to enable 100rel at this time.
    <param name="enable-100rel" value="true"/>				
				]]>
			</screen>
		</section>
	</section>



	<section id="freeswitch.number">
		<title>测试号码</title>
		<para>freeswitch提供了测试号码</para>
		<screen>
		<![CDATA[
号码		说明
9664	保持音乐
9196	echo，回音测试
9195	echo，回音测试，延迟5秒
9197	milliwatte extension，铃音生成
9198	TGML 铃音生成示例
5000	示例IVR4000听取语音信箱
33xx	电话会议，48K(其中xx可为00-99，下同)
32xx	电话会议，32K
31xx	电话会议，16K
30xx	电话会议，8K
2000-2002	呼叫组
1000-1019	默认分机号
		]]>
		</screen>
		<section>
			<title>测试分机号</title>
			<para>1000-1019 测试账号位置</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# ls /etc/freeswitch/directory/default/
1000.xml  1002.xml  1004.xml  1006.xml  1008.xml  1010.xml  1012.xml  1014.xml  1016.xml  1018.xml  brian.xml    example.com.xml
1001.xml  1003.xml  1005.xml  1007.xml  1009.xml  1011.xml  1013.xml  1015.xml  1017.xml  1019.xml  default.xml  skinny-example.xml			
			]]>
			</screen>
			<para>用户配置文件</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/directory/default/1000.xml 
<include>
  <user id="1000">
    <params>
      <param name="password" value="$${default_password}"/>
      <param name="vm-password" value="1000"/>
    </params>
    <variables>
      <variable name="toll_allow" value="domestic,international,local"/>
      <variable name="accountcode" value="1000"/>
      <variable name="user_context" value="default"/>
      <variable name="effective_caller_id_name" value="Extension 1000"/>
      <variable name="effective_caller_id_number" value="1000"/>
      <variable name="outbound_caller_id_name" value="$${outbound_caller_name}"/>
      <variable name="outbound_caller_id_number" value="$${outbound_caller_id}"/>
      <variable name="callgroup" value="techsupport"/>
    </variables>
  </user>
</include>
			]]>
			</screen>
			<para>账号密码在 /etc/freeswitch/vars.xml 配置文件中</para>
			<screen>
			<![CDATA[
<X-PRE-PROCESS cmd="set" data="default_password=eFyS2wcZo1zKZ3KG"/>
			]]>
			</screen>
			<para>用下面方法查看密码</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/vars.xml | grep default_password
       YOU SHOULD CHANGE THIS default_password value if you don't want to be subject to any
  <X-PRE-PROCESS cmd="set" data="default_password=eFo1zKZyS2wcZ3KG"/>		
			]]>
			</screen>
		</section>

	</section>

	<section id="switch.conf.xml">
		<title>switch.conf.xml</title>
		<screen>
			<![CDATA[
[root@netkiller ~]# cp /etc/freeswitch/autoload_configs/switch.conf.xml{,.backup}
[root@netkiller ~]# xmlstarlet ed -d '//comment()' /etc/freeswitch/autoload_configs/switch.conf.xml
			]]>
		</screen>
		<para>配置交换机名称</para>
		<screen>
			<![CDATA[
    <param name="switchname" value="netkiller"/>			
			]]>
		</screen>
		<para>RTP 端口范围</para>
		<screen>
			<![CDATA[
    <!-- RTP port range -->
    <!-- <param name="rtp-start-port" value="16384"/> -->
    <!-- <param name="rtp-end-port" value="32768"/> -->			
			]]>
		</screen>
		<para>日志级别</para>
		<screen>
			<![CDATA[
<param name="loglevel" value="debug"/>
			]]>
		</screen>
	</section>
	<section id="freeswitch.gateway">
		<title>网关配置</title>
		<para>参考 /etc/freeswitch/sip_profiles/external/example.xml 文件</para>
		<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/sip_profiles/external/example.xml
<include>
  <!--<gateway name="asterlink.com">-->
  <!--/// account username *required* ///-->
  <!--<param name="username" value="cluecon"/>-->
  <!--/// auth realm: *optional* same as gateway name, if blank ///-->
  <!--<param name="realm" value="asterlink.com"/>-->
  <!--/// username to use in from: *optional* same as  username, if blank ///-->
  <!--<param name="from-user" value="cluecon"/>-->
  <!--/// domain to use in from: *optional* same as  realm, if blank ///-->
  <!--<param name="from-domain" value="asterlink.com"/>-->
  <!--/// account password *required* ///-->
  <!--<param name="password" value="2007"/>-->
  <!--/// extension for inbound calls: *optional* same as username, if blank ///-->
  <!--<param name="extension" value="cluecon"/>-->
  <!--/// proxy host: *optional* same as realm, if blank ///-->
  <!--<param name="proxy" value="asterlink.com"/>-->
  <!--/// send register to this proxy: *optional* same as proxy, if blank ///-->
  <!--<param name="register-proxy" value="mysbc.com"/>-->
  <!--/// expire in seconds: *optional* 3600, if blank ///-->
  <!--<param name="expire-seconds" value="60"/>-->
  <!--/// do not register ///-->
  <!--<param name="register" value="false"/>-->
  <!-- which transport to use for register -->
  <!--<param name="register-transport" value="udp"/>-->
  <!--How many seconds before a retry when a failure or timeout occurs -->
  <!--<param name="retry-seconds" value="30"/>-->
  <!--Use the callerid of an inbound call in the from field on outbound calls via this gateway -->
  <!--<param name="caller-id-in-from" value="false"/>-->
  <!--extra sip params to send in the contact-->
  <!--<param name="contact-params" value=""/>-->
  <!-- Put the extension in the contact -->
  <!--<param name="extension-in-contact" value="true"/>-->
  <!--send an options ping every x seconds, failure will unregister and/or mark it down-->
  <!--<param name="ping" value="25"/>-->
  <!--<param name="cid-type" value="rpid"/>-->
  <!--rfc5626 : Abilitazione rfc5626 ///-->
  <!--<param name="rfc-5626" value="true"/>-->
  <!--rfc5626 : extra sip params to send in the contact-->
  <!--<param name="reg-id" value="1"/>-->
  <!--</gateway>-->
</include>
			]]>
		</screen>
		<para>配置网关</para>
		<screen>
			<![CDATA[
[root@netkiller ~]# cat > /etc/freeswitch/sip_profiles/external/hamsoverip.xml <<EOF
<include>
	<gateway name="hamsoverip.com">
		<param name="username" value="300177"/>
		<param name="realm" value="pbx-ap.hamsoverip.com:5160"/>
		<param name="password" value="178aee323ef95"/>
		<param name="register" value="true"/>
		<param name="register-transport" value="udp"/>
	</gateway>
</include>
EOF
			]]>
		</screen>
		<para>配置拨号规则</para>
		<screen>
			<![CDATA[
[root@netkiller ~]# cat > /etc/freeswitch/dialplan/default/hamsoverip.com.xml <<"EOF"
<include>
	<extension name="hamsoverip.com">
		<condition field="destination_number" expression="^300(\d+)$">
			<action application="bridge" data="sofia/gateway/hamsoverip.com/300$1"/>
		</condition>
	</extension>
</include>
EOF
			]]>
		</screen>
		<para>再举一个例子, 0 作为外拨号码</para>
		<screen>
			<![CDATA[
cat > /etc/freeswitch/sip_profiles/external/netkiller.xml <<EOF
<include>
	<gateway name="netkiller.cn">
		<param name="username" value="6000"/>
		<param name="realm" value="sip.netkiller.cn:5060"/>
		<param name="password" value="6000"/>
		<param name="register" value="true"/>
		<param name="register-transport" value="udp"/>
	</gateway>
</include>
EOF

cat > /etc/freeswitch/dialplan/default/netkiller.cn.xml <<"EOF"
<include>
	<extension name="netkiller.cn">
		<condition field="destination_number" expression="^0(\d+)$">
			<action application="bridge" data="sofia/gateway/netkiller.cn/$1"/>
		</condition>
	</extension>
</include>
EOF
	
			]]>
		</screen>
	</section>
	<section id="freeswitch.destination_number">
		<title>新增号段</title>
		<para></para>
		<screen>
			<![CDATA[
[root@netkiller ~]# cp /etc/freeswitch/dialplan/default.xml{,.backup}			
			]]>
		</screen>
		<screen>
			<![CDATA[
[root@netkiller ~]# vim /etc/freeswitch/dialplan/default.xml			
    <extension name="Local_Extension">
      <condition field="destination_number" expression="^(10[01][0-9])$">
        <action application="export" data="dialed_extension=$1"/>
        <!-- bind_meta_app can have these args <key> [a|b|ab] [a|b|o|s] <app> -->
        <action application="bind_meta_app" data="1 b s execute_extension::dx XML features"/>
        <action application="bind_meta_app" data="2 b s record_session::$${recordings_dir}/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"/>
        <action application="bind_meta_app" data="3 b s execute_extension::cf XML features"/>
        <action application="bind_meta_app" data="4 b s execute_extension::att_xfer XML features"/>
        <action application="set" data="ringback=${us-ring}"/>
        <action application="set" data="transfer_ringback=$${hold_music}"/>
        <action application="set" data="call_timeout=30"/>
        <!-- <action application="set" data="sip_exclude_contact=${network_addr}"/> -->
        <action application="set" data="hangup_after_bridge=true"/>
        <!--<action application="set" data="continue_on_fail=NORMAL_TEMPORARY_FAILURE,USER_BUSY,NO_ANSWER,TIMEOUT,NO_ROUTE_DESTINATION"/> -->
        <action application="set" data="continue_on_fail=true"/>
        <action application="hash" data="insert/${domain_name}-call_return/${dialed_extension}/${caller_id_number}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/${dialed_extension}/${uuid}"/>
        <action application="set" data="called_party_callgroup=${user_data(${dialed_extension}@${domain_name} var callgroup)}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/${called_party_callgroup}/${uuid}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/global/${uuid}"/>
        <!--<action application="export" data="nolocal:rtp_secure_media=${user_data(${dialed_extension}@${domain_name} var rtp_secure_media)}"/>-->
        <action application="hash" data="insert/${domain_name}-last_dial/${called_party_callgroup}/${uuid}"/>
        <action application="bridge" data="user/${dialed_extension}@${domain_name}"/>
        <action application="answer"/>
        <action application="sleep" data="1000"/>
        <action application="bridge" data="loopback/app=voicemail:default ${domain_name} ${dialed_extension}"/>
      </condition>
    </extension>
			]]>
		</screen>
		<para>默认拨号规则是 1000~1019</para>
		<screen>
			<![CDATA[
<condition field="destination_number" expression="^(10[01][0-9])$">			
			]]>
		</screen>
		<para>改为 1000~1099</para>
		<screen>
			<![CDATA[
<condition field="destination_number" expression="^(10[0-9][0-9])$">			
			]]>
		</screen>
		<para>分机号段为 1000~1999，2000</para>
		<screen>
			<![CDATA[
<condition field="destination_number" expression="^(1[0-9][0-9][0-9]|2000)$">			
			]]>
		</screen>
		<para>30000~39999 | 1000~1019</para>
		<screen>
			<![CDATA[
  <condition field="destination_number" expression="^(3\d{4}|10[01][0-9])$">
			]]>
		</screen>
		<para>长度 3 或 4 位数 100~199, 1000~1999</para>
		<screen>
			<![CDATA[
<condition field="destination_number" expression="^(1\d{2,3})$">			
			]]>
		</screen>
		<example>
			<title>拨号规则，配置两个号段 100~199，1000~1999</title>
			<para>拨出规则</para>
			<screen>
				<![CDATA[
[root@netkiller ~]# vim /etc/freeswitch/dialplan/default.xml				
    <extension name="Local_Extension">
      <!-- <condition field="destination_number" expression="^(10[01][0-9])$"> -->
      <condition field="destination_number" expression="^(1\d{2,3})$">
        <action application="export" data="dialed_extension=$1"/>
        <!-- bind_meta_app can have these args <key> [a|b|ab] [a|b|o|s] <app> -->
        <action application="bind_meta_app" data="1 b s execute_extension::dx XML features"/>
        <action application="bind_meta_app" data="2 b s record_session::$${recordings_dir}/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"/>
        <action application="bind_meta_app" data="3 b s execute_extension::cf XML features"/>
        <action application="bind_meta_app" data="4 b s execute_extension::att_xfer XML features"/>
        <action application="set" data="ringback=${us-ring}"/>
        <action application="set" data="transfer_ringback=$${hold_music}"/>
        <action application="set" data="call_timeout=30"/>
        <!-- <action application="set" data="sip_exclude_contact=${network_addr}"/> -->
        <action application="set" data="hangup_after_bridge=true"/>
        <!--<action application="set" data="continue_on_fail=NORMAL_TEMPORARY_FAILURE,USER_BUSY,NO_ANSWER,TIMEOUT,NO_ROUTE_DESTINATION"/> -->
        <action application="set" data="continue_on_fail=true"/>
        <action application="hash" data="insert/${domain_name}-call_return/${dialed_extension}/${caller_id_number}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/${dialed_extension}/${uuid}"/>
        <action application="set" data="called_party_callgroup=${user_data(${dialed_extension}@${domain_name} var callgroup)}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/${called_party_callgroup}/${uuid}"/>
        <action application="hash" data="insert/${domain_name}-last_dial_ext/global/${uuid}"/>
        <!--<action application="export" data="nolocal:rtp_secure_media=${user_data(${dialed_extension}@${domain_name} var rtp_secure_media)}"/>-->
        <action application="hash" data="insert/${domain_name}-last_dial/${called_party_callgroup}/${uuid}"/>
        <action application="bridge" data="user/${dialed_extension}@${domain_name}"/>
        <action application="answer"/>
        <action application="sleep" data="1000"/>
        <action application="bridge" data="loopback/app=voicemail:default ${domain_name} ${dialed_extension}"/>
      </condition>
    </extension>				
				]]>
			</screen>
			<para>拨入规则</para>
			<screen>
				<![CDATA[
[root@netkiller ~]# cp /etc/freeswitch/dialplan/public.xml{,.backup}

    <extension name="public_extensions">
      <!-- <condition field="destination_number" expression="^(10[01][0-9])$"> -->
      <condition field="destination_number" expression="^(1\d{2,3})$">
        <action application="transfer" data="$1 XML default"/>
      </condition>
    </extension>
				]]>
			</screen>

		</example>
		<para>更推荐的方式，是增加配置文件，不修改 public.xml 文件</para>
		<screen>
			<![CDATA[
[root@netkiller freeswitch]# cat dialplan/public/hoip.xml 
<include>

    <extension name="public_extensions">
      <condition field="destination_number" expression="^(1\d{2,3})$">
        <action application="transfer" data="$1 XML default"/>
      </condition>
    </extension>

</include>			
			]]>
		</screen>
	</section>
	<section id="logfile.conf.xml ">
		<title>logfile.conf.xml</title>
		<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/autoload_configs/logfile.conf.xml 
<configuration name="logfile.conf" description="File Logging">
  <settings>
   <!-- true to auto rotate on HUP, false to open/close -->
   <param name="rotate-on-hup" value="true"/>
  </settings>
  <profiles>
    <profile name="default">
      <settings>
        <!-- File to log to -->
        <!--<param name="logfile" value="/var/log/freeswitch.log"/>-->
        <!-- At this length in bytes rotate the log file (0 for never) -->
        <param name="rollover" value="1048576000"/>
                <!-- Maximum number of log files to keep before wrapping -->
                <!-- If this parameter is enabled, the log filenames will not include a date stamp -->
                <param name="maximum-rotate" value="32"/>
        <!-- Prefix all log lines by the session's uuid  -->
        <param name="uuid" value="true" />
      </settings>
      <mappings>
        <!-- 
             name can be a file name, function name or 'all' 
             value is one or more of debug,info,notice,warning,err,crit,alert,all
             Please see comments in console.conf.xml for more information
        -->
        <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
      </mappings>
    </profile>
  </profiles>
</configuration>			
			]]>
		</screen>
	</section>
	<section id="freeswitch.h246">
		<title>视频通话</title>
		<para>新增一项 proxy_media 配置</para>
		<screen>
		<![CDATA[
echo '<X-PRE-PROCESS cmd="set" data="proxy_media=true"/>' >> /etc/freeswitch/vars.xml

[root@netkiller ~]# echo '<X-PRE-PROCESS cmd="set" data="proxy_media=true"/>' >> /etc/freeswitch/vars.xml
[root@netkiller ~]# grep  'proxy_media' /etc/freeswitch/vars.xml
<X-PRE-PROCESS cmd="set" data="proxy_media=true"/>
		]]>
		</screen>
		<para>去掉 inbound-proxy-media 注释</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# egrep "inbound-proxy-media|inbound-late-negotiation" /etc/freeswitch/sip_profiles/internal.xml
    <!--<param name="inbound-proxy-media" value="true"/>-->
    <param name="inbound-late-negotiation" value="true"/>
    
<!--<param name="inbound-proxy-media" value="true"/>-->
修改
<param name="inbound-proxy-media" value="true"/>
    
[root@netkiller ~]# egrep "inbound-proxy-media|inbound-late-negotiation" /etc/freeswitch/sip_profiles/internal.xml
    <param name="inbound-proxy-media" value="true"/>
    <param name="inbound-late-negotiation" value="true"/>    
		]]>
		</screen>
	</section>
	<section id="freeswitch.voicemail">
		<title>语音邮箱(voicemail)</title>
		<para>确认 voicemail 模块是否启用</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# grep voicemail /etc/freeswitch/autoload_configs/modules.conf.xml 
    <load module="mod_voicemail"/>		
		]]>
		</screen>
		<para>语音信箱存储目录</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# ls /var/lib/freeswitch/storage/voicemail/default/sip.netkiller.com/
1000  1001  1002  1003  1004  1005  1006  1007  1009  1010  1011  1012  1013		
		]]>
		</screen>
		<para>拨打4000，根据提示输入user id和密码，就可以收听到留言了。</para>

	</section>
	<section id="freeswitch.directory">
		<title>多租户（多领域）配置</title>
		<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/directory/default/1000.xml			
<include>
     <domain name="sip.netkiller.cn">
         <user id="1000">
             <params>
                 <param name="password" value="1234"/>
             </params>
         </user>
         <user id="1001">
             <params>
                 <param name="password" value="1234"/>
             </params>
         </user>
     </domain>
 
     <domain name="voip.netkiller.cn">
         <user id="1000">
             <params>
                 <param name="password" value="1234"/>                                                                                                                                        
             </params>
         </user>
         <user id="1001">
             <params>
                 <param name="password" value="1234"/>
             </params>
         </user>
     </domain>
 </include>			
			]]>
		</screen>
	</section>
	<section id="freeswitch.directory.group">
		<title>组呼叫配置</title>
		<para>定义组呼叫拨号规则</para>
		<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/directory/default/1000.xml			
    <extension name="group_dial_sales">
      <condition field="destination_number" expression="^2000$">
        <action application="bridge" data="${group_call(sales@${domain_name})}"/>
      </condition>
    </extension>

    <extension name="group_dial_support">
      <condition field="destination_number" expression="^2001$">
        <action application="bridge" data="group/support@${domain_name}"/>
      </condition>
    </extension>

    <extension name="group_dial_billing">
      <condition field="destination_number" expression="^2002$">
        <action application="bridge" data="group/billing@${domain_name}"/>
      </condition>
    </extension>
			]]>
		</screen>
		<para>配置组内用户</para>
		<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/directory/default.xml 
<!--
    NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE

    FreeSWITCH works off the concept of users and domains just like email.
    You have users that are in domains for example 1000@domain.com.

    When freeswitch gets a register packet it looks for the user in the directory
    based on the from or to domain in the packet depending on how your sofia profile
    is configured.  Out of the box the default domain will be the IP address of the
    machine running FreeSWITCH.  This IP can be found by typing "sofia status" at the
    CLI.  You will register your phones to the IP and not the hostname by default.
    If you wish to register using the domain please open vars.xml in the root conf
    directory and set the default domain to the hostname you desire.  Then you would
    use the domain name in the client instead of the IP address to register
    with FreeSWITCH.

    NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE
-->

<include>
  <!--the domain or ip (the right hand side of the @ in the addr-->
  <domain name="$${domain}">
    <params>
      <param name="dial-string" value="{^^:sip_invite_domain=${dialed_domain}:presence_id=${dialed_user}@${dialed_domain}}${sofia_contact(*/${dialed_user}@${dialed_domain})},${verto_contact(${dialed_user}@${dialed_domain})}"/>
      <!-- These are required for Verto to function properly -->
      <param name="jsonrpc-allowed-methods" value="verto"/>
      <!-- <param name="jsonrpc-allowed-event-channels" value="demo,conference,presence"/> -->
    </params>

    <variables>
      <variable name="record_stereo" value="true"/>
      <variable name="default_gateway" value="$${default_provider}"/>
      <variable name="default_areacode" value="$${default_areacode}"/>
      <variable name="transfer_fallback_extension" value="operator"/>
    </variables>

    <groups>
      <group name="default">
        <users>
          <X-PRE-PROCESS cmd="include" data="default/*.xml"/>
        </users>
      </group>

      <group name="sales">
        <users>
          <!--
              type="pointer" is a pointer so you can have the
              same user in multiple groups.  It basically means
              to keep searching for the user in the directory.
          -->
          <user id="1000" type="pointer"/>
          <user id="1001" type="pointer"/>
          <user id="1002" type="pointer"/>
          <user id="1003" type="pointer"/>
          <user id="1004" type="pointer"/>
        </users>
      </group>

      <group name="billing">
        <users>
          <user id="1005" type="pointer"/>
          <user id="1006" type="pointer"/>
          <user id="1007" type="pointer"/>
          <user id="1008" type="pointer"/>
          <user id="1009" type="pointer"/>
        </users>
      </group>

      <group name="support">
        <users>
          <user id="1010" type="pointer"/>
          <user id="1011" type="pointer"/>
          <user id="1012" type="pointer"/>
          <user id="1013" type="pointer"/>
          <user id="1014" type="pointer"/>
        </users>
      </group>
    </groups>

  </domain>
</include>

			]]>
		</screen>
	</section>
	<section id="freeswitch.directory.callgroup">
		<title>代接电话</title>
		<para>有一组号码，他们可能在通话，你希望终止他们的通话，接到自己这边来，可以使用，代接电话功能。</para>
		<para>确认代接电话拨号规则已经配置 /etc/freeswitch/dialplan/default.xml</para>
		<screen>
			<![CDATA[
    <extension name="global-intercept">
      <condition field="destination_number" expression="^886$">
        <action application="answer"/>
        <action application="intercept" data="${hash(select/${domain_name}-last_dial_ext/global)}"/>
        <action application="sleep" data="2000"/>
      </condition>
    </extension>

    <extension name="group-intercept">
      <condition field="destination_number" expression="^\*8$">
        <action application="answer"/>
        <action application="intercept" data="${hash(select/${domain_name}-last_dial_ext/${callgroup})}"/>
        <action application="sleep" data="2000"/>
      </condition>
    </extension>

    <extension name="intercept-ext">
      <condition field="destination_number" expression="^\*\*(\d+)$">
        <action application="answer"/>
        <action application="intercept" data="${hash(select/${domain_name}-last_dial_ext/$1)}"/>
        <action application="sleep" data="2000"/>
      </condition>
    </extension>

    <extension name="redial">
      <condition field="destination_number" expression="^(redial|870)$">
        <action application="transfer" data="${hash(select/${domain_name}-last_dial/${caller_id_number})}"/>
      </condition>
    </extension>
			]]>
		</screen>
		<para>创建一组用户 callgroup 相同，此处的 callgroup 与 组呼叫 没有任何关系，callgroup
			是指代接电话组。
		</para>
		<screen>
			<![CDATA[
[root@production default]# cat /etc/freeswitch/directory/default/177.xml 
<include>
        <user id="177">
                <params>
                        <param name="password" value="0848"/>
                        <param name="vm-password" value="0848"/>
                </params>
                <variables>
                        <variable name="toll_allow" value="domestic,international,local"/>
                        <variable name="accountcode" value="177"/>
                        <variable name="user_context" value="default"/>
                        <variable name="effective_caller_id_name" value="BG7NYT"/>
                        <variable name="effective_caller_id_number" value="177"/>
                        <variable name="outbound_caller_id_name" value="$${outbound_caller_name}"/>
                        <variable name="outbound_caller_id_number" value="$${outbound_caller_id}"/>
                        <variable name="callgroup" value="bg7nyt"/>
                </variables>
        </user>
</include>			
			]]>
		</screen>
		<para>配置好后，你可以找几个电话测试，拨通一组后，用另一部话机不通 886 就能接管正在通话的号码。</para>
	</section>
	<section id="freeswitch.mysql">
		<title>MySQL 模块配置</title>
		<section>
			<title>安装 mariadb</title>
			<screen>
			<![CDATA[
yum install -y mariadb mariadb-server
service mariadb start
systemctl enable mariadb
mysql_secure_installation 			
			]]>
			</screen>
		</section>

		<section>
			<title>安装模块</title>
			<screen>
			<![CDATA[
[root@netkiller ~]# dnf install -y freeswitch-database-mariadb			
			]]>
			</screen>
		</section>
		<section>
			<title>启用 mysql 支持</title>
			<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/autoload_configs/pre_load_modules.conf.xml
<configuration name="pre_load_modules.conf" description="Modules">
  <modules>
    <!-- Databases -->
    <!-- <load module="mod_mariadb"/> -->
    <load module="mod_pgsql"/>
  </modules>
</configuration>		
			]]>
			</screen>
			<para>注释 mod_pgsql 启用 mod_mariadb</para>
			<screen>
			<![CDATA[
    <load module="mod_mariadb"/>
    <!-- <load module="mod_pgsql"/> -->
			]]>
			</screen>
		</section>
		<section>
			<title>db.conf.xml</title>
			<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/autoload_configs/db.conf.xml 
<configuration name="db.conf" description="LIMIT DB Configuration">
  <settings>
    <!--<param name="odbc-dsn" value="dsn:user:pass"/>-->
  </settings>
</configuration>			
			]]>
			</screen>
			<para></para>
			<screen>
			<![CDATA[
<configuration name="db.conf" description="LIMIT DB Configuration">
  <settings>
    <param name="core-db-dsn" value="mariadb://Server=192.168.0.11;Port=3307;Database=freeswitch;Uid=root;Pwd=123456;" />
  </settings>
</configuration>
			
			]]>
			</screen>
		</section>
		<section>
			<title>switch.conf.xml</title>
			<para>修改下面文件中的 core-db-dsn</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# vim /etc/freeswitch/autoload_configs/switch.conf.xml		
			]]>
			</screen>

			<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/autoload_configs/switch.conf.xml | grep dsn
    <!-- <param name="core-db-dsn" value="pgsql://hostaddr=127.0.0.1 dbname=freeswitch user=freeswitch password='' options='-c client_min_messages=NOTICE'" /> -->
    <!-- <param name="core-db-dsn" value="postgresql://freeswitch:@127.0.0.1/freeswitch?options=-c%20client_min_messages%3DNOTICE" /> -->
    <param name="core-db-dsn" value="mariadb://Server=localhost;Database=freeswitch;Uid=freeswitch;Pwd=pass;" />
    <!-- <param name="core-db-dsn" value="dsn:username:password" /> -->			
			]]>
			</screen>
		</section>
		<section>
			<title>修改 sip_profile 配置文件</title>
			<para>数据源格式</para>
			<screen>
			<![CDATA[
mariadb://Server=localhost;Database=freeswitch;Uid=freeswitch;Pwd=pass;		
			]]>
			</screen>
			<para>修改下面文件中的 odbc-dsn</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# vim /etc/freeswitch/autoload_configs/switch.conf.xml
[root@netkiller ~]# vim /etc/freeswitch/autoload_configs/db.conf.xml
[root@netkiller ~]# vim /etc/freeswitch/sip_profiles/internal.xml
[root@netkiller ~]# vim /etc/freeswitch/sip_profiles/internal-ipv6.xml
			]]>
			</screen>

		</section>
		<section>
			<title>检查配置</title>
			<para>用下面命令检查是否遗漏</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# grep -r 'odbc-dsn' /etc/freeswitch/*/*.xml
[root@netkiller ~]# grep -r 'core-db-dsn' /etc/freeswitch/*/*.xml
			]]>
			</screen>
		</section>
	</section>

	<section id="freeswitch.fs_cli">
		<title>fs_cli</title>
		<para>进入 fs_cli</para>
		<screen>
		<![CDATA[
[root@netkiller ~]# fs_cli 
.=======================================================.
|            _____ ____     ____ _     ___              |
|           |  ___/ ___|   / ___| |   |_ _|             |
|           | |_  \___ \  | |   | |    | |              |
|           |  _|  ___) | | |___| |___ | |              |
|           |_|   |____/   \____|_____|___|             |
|                                                       |
.=======================================================.
| Anthony Minessale II, Ken Rice,                       |
| Michael Jerris, Travis Cross                          |
| FreeSWITCH (http://www.freeswitch.org)                |
| Paypal Donations Appreciated: paypal@freeswitch.org   |
| Brought to you by ClueCon http://www.cluecon.com/     |
.=======================================================.

.=======================================================================================================.
|       _                            _    ____ _             ____                                       |
|      / \   _ __  _ __  _   _  __ _| |  / ___| |_   _  ___ / ___|___  _ __                             |
|     / _ \ | '_ \| '_ \| | | |/ _` | | | |   | | | | |/ _ \ |   / _ \| '_ \                            |
|    / ___ \| | | | | | | |_| | (_| | | | |___| | |_| |  __/ |__| (_) | | | |                           |
|   /_/   \_\_| |_|_| |_|\__,_|\__,_|_|  \____|_|\__,_|\___|\____\___/|_| |_|                           |
|                                                                                                       |
|    ____ _____ ____    ____             __                                                             |
|   |  _ \_   _/ ___|  / ___|___  _ __  / _| ___ _ __ ___ _ __   ___ ___                                |
|   | |_) || || |     | |   / _ \| '_ \| |_ / _ \ '__/ _ \ '_ \ / __/ _ \                               |
|   |  _ < | || |___  | |__| (_) | | | |  _|  __/ | |  __/ | | | (_|  __/                               |
|   |_| \_\|_| \____|  \____\___/|_| |_|_|  \___|_|  \___|_| |_|\___\___|                               |
|                                                                                                       |
|     ____ _             ____                                                                           |
|    / ___| |_   _  ___ / ___|___  _ __         ___ ___  _ __ ___                                       |
|   | |   | | | | |/ _ \ |   / _ \| '_ \       / __/ _ \| '_ ` _ \                                      |
|   | |___| | |_| |  __/ |__| (_) | | | |  _  | (_| (_) | | | | | |                                     |
|    \____|_|\__,_|\___|\____\___/|_| |_| (_)  \___\___/|_| |_| |_|                                     |
|                                                                                                       |
.=======================================================================================================.

Type /help <enter> to see a list of commands		
		]]>
		</screen>
		<para>输入密码，并进入客户端</para>
		<screen>
		<![CDATA[
fs_cli -H 127.0.0.1 -P 8021 -p password	
		]]>
		</screen>
		<section id="event_socket.conf.xml">
			<title>fs_cli Socket Client 配置</title>
			<para>默认是 :: 表示 ipv6 localhost，如果需要远程访问可以改为 listen-ip 0.0.0.0</para>
			<screen>
			<![CDATA[
[root@netkiller ~]# cp /etc/freeswitch/autoload_configs/event_socket.conf.xml{,.backup}
[root@netkiller ~]# cat /etc/freeswitch/autoload_configs/event_socket.conf.xml
<configuration name="event_socket.conf" description="Socket Client">
  <settings>
    <param name="nat-map" value="false"/>
    <param name="listen-ip" value="::"/>
    <param name="listen-port" value="8021"/>
    <param name="password" value="ClueCon"/>
    <!--<param name="apply-inbound-acl" value="loopback.auto"/>-->
    <!--<param name="stop-on-bind-error" value="true"/>-->
  </settings>
</configuration>			
			]]>
			</screen>
			<screen>
			<![CDATA[
[root@netkiller ~]# cat /etc/freeswitch/autoload_configs/event_socket.conf.xml 
<configuration name="event_socket.conf" description="Socket Client">
  <settings>
    <param name="nat-map" value="false"/>
    <param name="listen-ip" value="127.0.0.1"/>
    <param name="listen-port" value="8021"/>
    <param name="password" value="netkiller"/>
    <!--<param name="apply-inbound-acl" value="loopback.auto"/>-->
    <!--<param name="stop-on-bind-error" value="true"/>-->
  </settings>
</configuration>
			]]>
			</screen>
			<screen>
			<![CDATA[
[root@netkiller ~]# fs_cli -p netkiller			
			]]>
			</screen>
		</section>
		<section>
			<title>退出 fs_cli</title>
			<screen>
			<![CDATA[
/exit
			]]>
			</screen>
		</section>
		<section id="fa_cli.log">
			<title>日志</title>

			<section id="console.loglevel">
				<title>loglevel</title>
				<para>console loglevel （0~7）</para>
				<screen>
			<![CDATA[
console loglevel 3			
			]]>
				</screen>
			</section>
			<section id="nolog">
				<title>关闭日志</title>
				<screen>
			<![CDATA[
freeswitch@-ERR switchname Command not found!> /nolog
+OK no longer logging			
			]]>
				</screen>
			</section>
		</section>
		<section id="sofia.profile">
			<title>profile</title>
			<screen>
			<![CDATA[
打开sip详细日志
sofia profile internal siptrace on

关闭sip详细日志
sofia profile internal siptrace off			
			]]>
			</screen>
		</section>
		<section id="sofia.status">
			<title>sofia status</title>
			<screen>
			<![CDATA[
[root@netkiller ~]# fs_cli -x "sofia status"
                     Name          Type                                       Data      State
=================================================================================================
            external-ipv6       profile                   sip:mod_sofia@[::1]:5080      RUNNING (0)
          sip.netkiller.cn         alias                                   internal      ALIASED
                 external       profile           sip:mod_sofia@192.168.0.230:5080      RUNNING (0)
    external::example.com       gateway                    sip:joeuser@example.com      NOREG
     external::hamsoverip       gateway      sip:300177@pbx-ap.hamsoverip.com:5160      REGED
            internal-ipv6       profile                   sip:mod_sofia@[::1]:5060      RUNNING (0)
                 internal       profile           sip:mod_sofia@192.168.0.230:5060      RUNNING (0)
=================================================================================================
4 profiles 1 alias			
			]]>
			</screen>

		</section>
		<section id="sofia.profile.internal.siptrace">
			<title>sip 抓包</title>
			<screen>
			<![CDATA[
sofia profile internal siptrace on
sofia profile external siptrace on	
			]]>
			</screen>

		</section>

		<section id="sofia.status.profile.internal">
			<title>internal 状态查看</title>
			<screen>
			<![CDATA[
freeswitch@-ERR switchname Command not found!> sofia status profile internal
=================================================================================================
Name                    internal
Domain Name             N/A
Auto-NAT                true
DBName                  sofia_reg_internal
Pres Hosts              sip.netkiller.com,192.168.0.230
Dialplan                XML
Context                 public
Challenge Realm         auto_from
RTP-IP                  192.168.0.230
Ext-RTP-IP              121.37.215.251
SIP-IP                  192.168.0.230
Ext-SIP-IP              121.37.215.251
URL                     sip:mod_sofia@192.168.0.230:5060
BIND-URL                sip:mod_sofia@192.168.0.230:5060;transport=udp,tcp
WS-BIND-URL             sip:mod_sofia@192.168.0.230:5066;transport=ws
WSS-BIND-URL            sips:mod_sofia@192.168.0.230:7443;transport=wss
HOLD-MUSIC              local_stream://moh
OUTBOUND-PROXY          N/A
CODECS IN               OPUS,G722,G729,PCMU,PCMA,H264,VP8
CODECS OUT              OPUS,G722,G729,PCMU,PCMA,H264,VP8
TEL-EVENT               101
DTMF-MODE               rfc2833
CNG                     13
SESSION-TO              0
MAX-DIALOG              0
MAX-RECV-RPS            1000
NOMEDIA                 false
LATE-NEG                true
PROXY-MEDIA             true
AGGRESSIVENAT           false
CALLS-IN                195
FAILED-CALLS-IN         99
CALLS-OUT               22
FAILED-CALLS-OUT        14
REGISTRATIONS           8
			
			]]>
			</screen>
		</section>
		<section id="sofia.status.profile.external">
			<title>external 状态</title>
			<screen>
			<![CDATA[
freeswitch@-ERR switchname Command not found!> sofia status profile external
=================================================================================================
Name                    external
Domain Name             N/A
Auto-NAT                true
DBName                  sofia_reg_external
Pres Hosts       
Dialplan                XML
Context                 public
Challenge Realm         auto_to
RTP-IP                  192.168.0.230
Ext-RTP-IP              121.37.215.251
SIP-IP                  192.168.0.230
Ext-SIP-IP              121.37.215.251
URL                     sip:mod_sofia@192.168.0.230:5080
BIND-URL                sip:mod_sofia@192.168.0.230:5080;transport=udp,tcp
HOLD-MUSIC              local_stream://moh
OUTBOUND-PROXY          N/A
CODECS IN               OPUS,G722,G729,PCMU,PCMA,H264,VP8
CODECS OUT              OPUS,G722,G729,PCMU,PCMA,H264,VP8
TEL-EVENT               101
DTMF-MODE               rfc2833
CNG                     13
SESSION-TO              0
MAX-DIALOG              0
MAX-RECV-RPS            1000
NOMEDIA                 false
LATE-NEG                true
PROXY-MEDIA             false
AGGRESSIVENAT           false
CALLS-IN                3
FAILED-CALLS-IN         3
CALLS-OUT               0
FAILED-CALLS-OUT        0
REGISTRATIONS           0			
			]]>
			</screen>
		</section>

		<section id="sofia.status.profile.internal.reg">
			<title>注册状态查看</title>
			<screen>
			<![CDATA[
[root@netkiller ~]# fs_cli -x "sofia status profile internal reg"

Registrations:
=================================================================================================
Call-ID:        1_4246134458@192.168.123.55
User:           1008@sip.netkiller.cn
Contact:        "1008" <sip:1008@192.168.123.55:5060;fs_nat=yes;fs_path=sip%3A1008%40223.74.131.87%3A20508>
Agent:          Yealink SIP-T21P_E2 52.84.0.125
Status:         Registered(UDP-NAT)(unknown) EXP(2025-04-06 19:32:38) EXPSECS(2540)
Ping-Status:    Reachable
Ping-Time:      0.00
Host:           netkiller
IP:             223.74.131.87
Port:           20508
Auth-User:      1008
Auth-Realm:     sip.netkiller.cn
MWI-Account:    1008@sip.netkiller.cn

Call-ID:        212FF149-109A-40AF-A2CF-23003FC53819
User:           1002@sip.netkiller.cn
Contact:        "BG7NYT" <sip:1002@172.16.0.11:5060;fs_nat=yes;fs_path=sip%3A1002%40112.97.167.132%3A13917>
Agent:          Jami Daemon 16.0.0-fc3402940f (macOS)
Status:         Registered(UDP-NAT)(unknown) EXP(2025-04-06 19:39:37) EXPSECS(2959)
Ping-Status:    Reachable
Ping-Time:      0.00
Host:           netkiller
IP:             112.97.167.132
Port:           13917
Auth-User:      1002
Auth-Realm:     sip.netkiller.cn
MWI-Account:    1002@sip.netkiller.cn

Call-ID:        139311fc-5f0ee947@172.16.0.10
User:           1000@sip.netkiller.cn
Contact:        "BG7NYT" <sip:1000@172.16.0.10:5060;fs_nat=yes;fs_path=sip%3A1000%40112.97.167.132%3A12689>
Agent:          Linksys/PAP2T-5.1.6(LS)
Status:         Registered(UDP-NAT)(unknown) EXP(2025-04-06 19:39:51) EXPSECS(2973)
Ping-Status:    Reachable
Ping-Time:      0.00
Host:           netkiller
IP:             112.97.167.132
Port:           12689
Auth-User:      1000
Auth-Realm:     sip.netkiller.cn
MWI-Account:    1000@sip.netkiller.cn

Call-ID:        5A7530FB452FDFDC5BDCD7E3A73DF6EEBC4D93D0
User:           1006@sip.netkiller.cn
Contact:        "" <sip:1006@10.65.4.4:23015;rinstance=18F4361D;fs_nat=yes;fs_path=sip%3A1006%40167.99.119.244%3A23015%3Brinstance%3D18F4361D>
Agent:          Acrobits SIPIS
Status:         Registered(UDP-NAT)(unknown) EXP(2025-04-06 18:57:03) EXPSECS(405)
Ping-Status:    Reachable
Ping-Time:      0.00
Host:           netkiller
IP:             167.99.119.244
Port:           23015
Auth-User:      1006
Auth-Realm:     sip.netkiller.cn
MWI-Account:    1006@sip.netkiller.cn

Total items returned: 4
=================================================================================================			
			]]>
			</screen>
		</section>
		<section id="sofia.profile.internal.rescan">
			<title>呼叫</title>
			<para>重新扫描加载 sip profile</para>
			<screen>
			<![CDATA[
sofia profile internal rescan
sofia profile external rescan
			]]>
			</screen>
			<para>重启 sip profile</para>
			<screen>
			<![CDATA[
sofia profile internal restart
sofia profile external restart
			]]>
			</screen>
		</section>
		<section id="show.calls">
			<title>呼叫</title>
			<screen>
			<![CDATA[
# 显示当前呼叫
show calls

# 显示呼叫数量
show calls count

# 挂断某个呼叫
uuid_kill 59b857d2-d7b8-4c7e-6666-e19be0f16643

# 挂断所有呼叫
hupall

# 拨打某个用户并启用echo回音
originate user/1000 &echo
			]]>
			</screen>
		</section>
		<section id="fs_cli.originate">
			<title>呼叫测试</title>
			<screen>
			<![CDATA[
回音测试
originate user/1000 &echo

停泊
originate user/1000 &park  # 停泊

保持
originate user/1000 &hold # 保持

播放放音
originate user/1000 &playback(/root/welclome.wav) # 播放音乐

呼叫并录音
originate user/1000 &record(/tmp/vocie_of_alice.wav) # 呼叫并录音

同振与顺振
#经过特定的SIP服务器发起外呼，下面的命令会将INVITE先发送到192.168.2.4:5060上
bgapi originate sofia/external/8005@001.com;fs_path=sip:192.168.2.4:5060 &echo 

经过特定SIP服务器
#经过特定的SIP服务器发起外呼，下面的命令会将INVITE先发送到192.168.2.4:5060上
bgapi originate sofia/external/8005@001.com;fs_path=sip:192.168.2.4:5060 &echo 

忽略early media
originate {ignore_early_media=true}user/1000 &echo

播放假的early media
originate {transfer_ringback=local_stream://moh}user/1000 &echo

立即播放early media
originate {instant_ringback=true}{transfer_ringback=local_stream://moh}user/1000 &echo

设置外显号码
originate {origination_callee_id_name=7777}user/1000
			]]>
			</screen>
		</section>
		<section id="fs_cli.regex">
			<title>正则测试</title>
			<screen>
			<![CDATA[
regex 123123 | \d
regex 123123 | ^\d*
			]]>
			</screen>
		</section>
		<section id="fs_cli.eval">
			<title>变量求值</title>
			<screen>
			<![CDATA[
eval $${mod_dir}
eval $${recording_dir}
			]]>
			</screen>
		</section>
	</section>
	<section id="freeswitch.lang">
		<title>中文语音包</title>
		<ulink url="https://files.freeswitch.org/releases/sounds/" />
		<screen>
		<![CDATA[
[   ]	freeswitch-sounds-zh-cn-sinmei-8000-1.0.51.tar.gz	2014-10-09 20:21	296K	 
[   ]	freeswitch-sounds-zh-cn-sinmei-8000-1.0.51.tar.gz.md5	2014-10-09 20:21	92	 
[   ]	freeswitch-sounds-zh-cn-sinmei-8000-1.0.51.tar.gz.sha1	2014-10-09 20:21	101	 
[   ]	freeswitch-sounds-zh-cn-sinmei-8000-1.0.51.tar.gz.sha256	2014-10-09 20:21	127	 
[   ]	freeswitch-sounds-zh-cn-sinmei-16000-1.0.51.tar.gz	2014-10-09 20:21	583K	 
[   ]	freeswitch-sounds-zh-cn-sinmei-16000-1.0.51.tar.gz.md5	2014-10-09 20:21	93	 
[   ]	freeswitch-sounds-zh-cn-sinmei-16000-1.0.51.tar.gz.sha1	2014-10-09 20:21	102	 
[   ]	freeswitch-sounds-zh-cn-sinmei-16000-1.0.51.tar.gz.sha256	2014-10-09 20:21	128	 
[   ]	freeswitch-sounds-zh-cn-sinmei-32000-1.0.51.tar.gz	2014-10-09 20:21	1.1M	 
[   ]	freeswitch-sounds-zh-cn-sinmei-32000-1.0.51.tar.gz.md5	2014-10-09 20:21	93	 
[   ]	freeswitch-sounds-zh-cn-sinmei-32000-1.0.51.tar.gz.sha1	2014-10-09 20:21	102	 
[   ]	freeswitch-sounds-zh-cn-sinmei-32000-1.0.51.tar.gz.sha256	2014-10-09 20:21	128	 
[   ]	freeswitch-sounds-zh-cn-sinmei-48000-1.0.51.tar.gz	2014-10-09 20:21	1.6M	 
[   ]	freeswitch-sounds-zh-cn-sinmei-48000-1.0.51.tar.gz.md5	2014-10-09 20:21	93	 
[   ]	freeswitch-sounds-zh-cn-sinmei-48000-1.0.51.tar.gz.sha1	2014-10-09 20:21	102	 
[   ]	freeswitch-sounds-zh-cn-sinmei-48000-1.0.51.tar.gz.sha256	2014-10-09 20:21	128	 
		]]>
		</screen>
		<para>编译 mod_say_zh 模块</para>
		<screen>
		<![CDATA[
cd /usr/local/src/freeswitch/src/mod/say/mod_say_zh
 
make && make install		
		]]>
		</screen>
		<para>autoload_configs/modules.conf.xml</para>
		<screen>
		<![CDATA[
    <!-- Say -->
    <load module="mod_say_en"/>
 
    <load module="mod_say_zh"/>
		
		]]>
		</screen>
		<para></para>
		<screen>
		<![CDATA[
cd /usr/local/freeswitch/conf/lang/
cp -fr en zh
cd zh
mv en.xml zh.xml
		
		]]>
		</screen>
		<para>zh.xml</para>
		<screen>
		<![CDATA[
<language name="zh" say-module="zh" sound-prefix="$${sounds_dir}/zh/cn/link" tts-engine="mod_tts_commandline" tts-voice="link">		
		]]>
		</screen>
		<para>vars.xml</para>
		<screen>
		<![CDATA[
  <X-PRE-PROCESS cmd="set" data="sound_prefix=$${sounds_dir}/zh/cn/link"/>
  <X-PRE-PROCESS cmd="set" data="default_language=zh"/>
  <X-PRE-PROCESS cmd="set" data="default_dialect=cn"/>
  <X-PRE-PROCESS cmd="set" data="default_voice=link"/>		
		]]>
		</screen>
		<para>freeswitch.xml</para>
		<screen>
		<![CDATA[
<X-PRE-PROCESS cmd="include" data="lang/zh/*.xml"/>		
		]]>
		</screen>
		<para>fs_cli 手动加载模块</para>
		<screen>
		<![CDATA[ 
load mod_say_zh
reloadxml
		
		]]>
		</screen>
		<para>配置 Dialplan 拨号计划 dialplan/default.xml</para>
		<screen>
		<![CDATA[
    <!--say测试-->
	<extension name="socket_767_example">
		<condition field="destination_number" expression="^767\d+$">
		    <action application="answer"/>
			<action application="say" data="zh name_spelled intered 3456789"></action>
            <action application="say" data="en NUMBER intered 3456789"></action>
            <action application="say" data="zh TELEPHONE_NUMBER intered 13781655437"></action>
            <action application="playback" data="voicemail/vm-goodbye.wav"></action>
		</condition>
	</extension>
		]]>
		</screen>
		<para>单个用户配置 1001.xml</para>
		<screen>
		<![CDATA[
<variable name="language" value="zh"/>
<variable name="default_language" value="zh"/>		
		]]>
		</screen>
		<para>dialplan中配置中文</para>
		<screen>
		<![CDATA[
	<extension name="ivr_demo">
      <condition field="destination_number" expression="^5000$">
        <action application="set" data="language=zh"/>
        <action application="answer"/>
        <action application="sleep" data="2000"/>
        <action application="ivr" data="demo_ivr"/>
      </condition>
    </extension>
		
		]]>
		</screen>
	</section>
	<section id="freeswitch.tls">
		<title>TLS</title>
		<section>
			<title>创建 CA 根证书</title>
			<screen>
				<![CDATA[
[root@netkiller freeswitch]# gentls_cert -h
/usr/bin/gentls_cert <setup|create_server|create_client|clean> [options]

  * commands:

    setup  - Setup new CA
    remove - Remove CA

    create_server - Create new certificate (overwriting existing!)
    create_client - Create a new client certificate (overwrites existing!)

  * options:

   -cn       Set common name
   -alt      Set alternative name (use prefix 'DNS:' or 'URI:')
   -org      Set organization name
   -out      Filename for new certificate (create only)
   -days     Certificate expires in X days (default: 365)				
				]]>
			</screen>
			<para>用法举例</para>
			<screen>
				<![CDATA[
[root@netkiller freeswitch]# gentls_cert setup -cn pbx.freeswitch.org -alt DNS:pbx.freeswitch.org -org freeswitch.org
Creating new CA...
..+.....+......+++++++++++++++++++++++++++++++++++++++*....+...+...+..........+.....+......+...+.+.........+..+......+...+..........+.....+.+++++++++++++++++++++++++++++++++++++++*.+..+.......+.....+......+.......+........+.........+............+....+...............+....................+.+...+.....+......+.++++++
...+...+.+......+..+.+......+........+...+..........+........+.+......+...+.....+++++++++++++++++++++++++++++++++++++++*..+.......+...+...+..............+.+...+..+++++++++++++++++++++++++++++++++++++++*.......+..+.+..+..................+.+...++++++
-----
DONE			
				]]>
			</screen>
			<para>下面是我的证书</para>
			<screen>
				<![CDATA[
[root@netkiller freeswitch]# gentls_cert setup -cn sip.netkiller.cn -alt DNS:sip.netkiller.cn -org netkiller.cn
Creating new CA...
..........+............+++++++++++++++++++++++++++++++++++++++*....+.........+.......+.....+.+.........+.....+.+...+++++++++++++++++++++++++++++++++++++++*....+.....+............+...+.+...+......+.....+..........+......+........+...+..........+............+...+.....+.......+......+............+..+......+.+.....+.+..+......+.+.........+..+...+.+...........+.........+.+.....+.........+...+..........+.....+.+.....+....+........+.............+......+........+.+......+.....+......+........................+..........+...+.....+......+.......+...+.........+...+...+.....+......+.+.....+...+....+..+.+..+.......+...........+.............+.........+......+..+....+...+......+.....+.......+........+......+...+...+.......+...+..+...+.......+......+.........+..+..........+.....+...+..........+...........+.+......+..+.+.....................+......+........+....+........+.........+.+...+.........+...........+..........+.....+.........+.+....................+.+...+..+.+..............+.........+.........+.+..............+.+..+....+........+......+.+...+.....+.+......+.........+..+.......+...+..++++++
.+.......+.....+.......+..+.............+..+.+.........+...+..+++++++++++++++++++++++++++++++++++++++*......+......+..+...+.........+++++++++++++++++++++++++++++++++++++++*...+.......+........+....+.....+...+...+.+.....+......+..........+...+..+.......+.....+...+...+....+............+.....+...+......+.+.....+....+..+....+..........................+.......+...+..+.+......+...+..+.............+...............+..+....+.....+.+.........+..+...+....+........+...+....+...+..............+...+.+........................+............+........+......+.+......+.....+....+.....+..........+....................+...+.+..+.........+......+...+.+...+........+.......+......+.....++++++
-----
DONE
[root@netkiller freeswitch]# find /etc/freeswitch/tls/CA
/etc/freeswitch/tls/CA
/etc/freeswitch/tls/CA/config.tpl
/etc/freeswitch/tls/CA/cacert.pem
/etc/freeswitch/tls/CA/cakey.pem	
				]]>
			</screen>
			<para>查看证书</para>
			<screen>
			<![CDATA[
[root@netkiller freeswitch]#  openssl x509 -noout -inform pem -text -in /etc/freeswitch/tls/CA/cacert.pem
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            4b:5a:19:ce:0c:2f:65:ea:13:3b:4b:41:0f:23:62:dc:b1:1c:b2:21
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=sip.netkiller.cn, O=netkiller.cn
        Validity
            Not Before: Apr 24 03:00:09 2025 GMT
            Not After : Apr 23 03:00:09 2031 GMT
        Subject: CN=sip.netkiller.cn, O=netkiller.cn
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:b7:98:fc:18:95:98:86:25:80:be:b9:e4:34:52:
                    09:b5:17:ce:73:60:5a:0b:87:91:6c:6b:44:97:4c:
                    2c:7b:15:de:80:5a:0f:a2:b7:67:ab:8e:57:4f:3b:
                    b5:e8:8a:d9:da:02:dc:d5:f0:28:9f:bc:0a:a6:c2:
                    c9:64:a8:aa:a9:f1:ae:38:b1:8e:83:2b:50:80:c3:
                    5c:7f:8b:17:8c:fa:ee:b8:ac:33:dd:4f:f6:43:7f:
                    1f:5d:ed:0f:45:cb:e8:3d:b7:36:18:77:49:59:10:
                    6b:8c:d1:c3:bf:34:68:55:45:5f:24:ac:12:18:c9:
                    bf:52:6b:f6:37:5b:b8:d2:05:7a:db:b2:1b:e3:a3:
                    8d:92:9e:b7:f3:01:27:a2:1a:a7:07:21:4c:0e:d5:
                    2a:cb:0e:ff:ea:56:06:e4:29:be:26:97:60:bb:6c:
                    ac:ac:8c:8f:d2:52:38:94:d2:5c:0e:8c:cc:d2:c4:
                    eb:26:0b:22:78:f5:d5:70:9b:d7:fa:b5:60:87:aa:
                    ff:92:73:02:ad:b0:c7:41:8d:86:90:cd:ae:91:e1:
                    61:15:52:eb:37:e9:6b:8b:40:eb:31:36:93:d6:e1:
                    ff:8d:e6:9a:d9:84:8a:14:7a:50:57:b2:75:be:8c:
                    a6:b0:8e:24:cb:1a:ff:42:b7:c2:4f:05:23:0d:c3:
                    9c:45
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: 
                CE:04:C9:83:F9:1B:36:BE:27:25:53:77:62:15:60:E8:55:35:83:72
            X509v3 Authority Key Identifier: 
                CE:04:C9:83:F9:1B:36:BE:27:25:53:77:62:15:60:E8:55:35:83:72
            X509v3 Basic Constraints: 
                CA:TRUE
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        ac:0d:15:4b:92:d3:09:3a:f3:3a:19:68:1f:bf:e4:ef:bb:89:
        71:75:77:97:ae:c7:df:a1:5d:16:12:32:8a:f2:03:43:dc:78:
        22:60:12:dc:4e:b5:aa:70:78:28:d4:bf:38:6c:0b:6c:f5:9f:
        2c:3d:90:bf:a6:1d:52:24:5e:21:38:69:bb:a5:de:ee:31:45:
        e7:cf:bd:86:7e:4e:ff:a5:97:9a:43:9b:4f:7e:f6:98:ae:5e:
        aa:73:6b:14:ee:5a:73:ba:c8:02:f2:11:70:b3:5d:ad:4d:dc:
        75:08:05:45:de:46:2c:21:fb:6c:ae:e6:7f:48:0f:ed:49:5f:
        c1:1e:53:7c:c0:4e:11:20:52:78:2f:0a:fe:8b:ae:df:bf:5d:
        0e:97:a7:9c:3a:1d:6c:28:9d:f5:6b:cb:13:eb:b0:32:61:ce:
        50:b8:49:f4:4d:1b:25:83:31:9f:3b:09:6a:74:35:2c:09:6d:
        a3:80:a5:01:db:70:5c:71:b6:94:15:35:01:f4:e0:b9:6e:f8:
        b3:d2:2c:e9:0f:68:16:7f:e6:b9:a7:2f:08:3b:e4:dc:b9:4c:
        50:f4:94:65:97:d0:4a:89:8d:23:63:a7:26:52:04:80:28:ec:
        57:13:f8:e6:e9:09:e3:81:f8:67:5f:36:2a:fc:55:74:7e:c5:
        0b:4c:a3:d3			
			]]>
			</screen>
			<para>删除证书</para>
			<screen>
				<![CDATA[
[root@netkiller freeswitch]# gentls_cert remove
Are you sure you want to delete the CA? [YES to delete]
YES
Removing CA
DONE			
				]]>
			</screen>

			<para>删除证书</para>
			<screen>
				<![CDATA[
[root@netkiller freeswitch]# gentls_cert remove
Are you sure you want to delete the CA? [YES to delete]
YES
Removing CA
DONE			
				]]>
			</screen>
		</section>
		<section>
			<title>创建服务器证书</title>
			<screen>
			<![CDATA[
gentls_cert create_server -cn sip.netkiller.cn -alt DNS:sip.netkiller.cn -org netkiller.cn
			]]>
			</screen>
			<screen>
			<![CDATA[
[root@production ~]# gentls_cert create_server -cn sip.netkiller.cn -alt DNS:sip.netkiller.cn -org netkiller.cn
Generating new certificate...

--------------------------------------------------------
CN: "sip.netkiller.cn"
ORG_NAME: "netkiller.cn"
ALT_NAME: "DNS:sip.netkiller.cn"

Certificate filename "agent.pem"

[Is this OK? (y/N)]
y
..+++++++++++++++++++++++++++++++++++++++*.....+......+.......+...+..+..........+............+...........+...+...............+.......+............+..+.+...+......+.....+....+.....+....+.....+.+.....+.......+...+......+.........+.....+.+.....+...+...+.......+........+...+......+.............+.....+.+.....+.+...+...+.....+.........................+..+......+.+.....+.........+....+........+++++++++++++++++++++++++++++++++++++++*......+...+....+...+........+....+...+..++++++
.+++++++++++++++++++++++++++++++++++++++*..+...............+++++++++++++++++++++++++++++++++++++++*.+......+.++++++
-----
Certificate request self-signature ok
subject=CN=sip.netkiller.cn, O=netkiller.cn
DONE			
			]]>
			</screen>
			<para>检查证书</para>
			<screen>
			<![CDATA[
[root@production ~]# openssl x509 -noout -inform pem -text -in /etc/freeswitch/tls/agent.pem 
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            29:e8:64:33:a5:79:35:54:7d:79:33:1c:73:07:9c:bc:e1:87:5f:d7
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=sip.netkiller.cn, O=netkiller.cn
        Validity
            Not Before: May  3 09:09:03 2025 GMT
            Not After : May  2 09:09:03 2031 GMT
        Subject: CN=sip.netkiller.cn, O=netkiller.cn
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:ca:a3:99:20:81:3b:12:99:57:58:15:15:48:76:
                    83:34:84:73:e4:bf:1a:43:2a:39:a6:4e:4c:17:dd:
                    e9:16:be:17:cb:50:ad:77:f2:1b:b7:bc:c4:c1:ae:
                    7c:99:01:68:94:4c:e0:37:2f:25:4f:bc:18:e1:4b:
                    db:c8:f9:65:8d:3e:81:76:17:05:54:e3:40:b2:0e:
                    66:c4:62:fe:93:ee:9b:c8:54:df:4f:52:bf:d1:d0:
                    7a:0f:18:98:79:59:56:49:08:9e:fb:41:53:fb:fd:
                    23:84:87:a9:4b:f0:5c:0b:33:62:d2:7e:da:42:52:
                    d2:c9:9f:c0:90:ac:a4:45:55:fd:fa:52:c5:c3:9a:
                    b3:58:e9:3c:55:49:a9:c8:8c:22:4b:07:d8:db:7b:
                    9c:9f:2c:85:ad:dc:56:f3:35:86:52:bf:bf:98:2b:
                    fd:ea:d8:56:08:c9:60:5d:41:72:0c:bf:cf:7c:8c:
                    4d:c6:46:85:6e:d7:94:2a:71:b5:97:72:5f:a6:2a:
                    55:a7:74:f8:80:e5:87:77:bb:66:d5:9d:59:5b:09:
                    03:df:3f:da:38:58:21:3b:a8:17:2d:c7:9d:a4:02:
                    1a:30:a4:58:3e:a2:5b:54:37:92:e1:fe:5f:bd:55:
                    3b:06:f2:75:5f:ae:57:2d:9e:39:65:fa:61:6f:f1:
                    a4:e3
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            Netscape Comment: 
                FS Server Cert
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Subject Key Identifier: 
                43:52:D7:63:2C:34:60:96:97:0B:CE:70:6A:27:70:C3:75:EF:CB:B3
            X509v3 Authority Key Identifier: 
                keyid:CE:04:C9:83:F9:1B:36:BE:27:25:53:77:62:15:60:E8:55:35:83:72
                DirName:/CN=sip.netkiller.cn/O=netkiller.cn
                serial:4B:5A:19:CE:0C:2F:65:EA:13:3B:4B:41:0F:23:62:DC:B1:1C:B2:21
            X509v3 Subject Alternative Name: 
                DNS:sip.netkiller.cn
            Netscape Cert Type: 
                SSL Server
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        2f:e7:58:51:35:04:45:b0:72:6d:60:3f:b7:16:6f:78:4f:07:
        91:c3:ff:dc:ea:4c:19:d0:1c:df:2b:24:16:23:b3:7c:e7:0f:
        1c:ab:d3:a5:9b:f0:a2:0a:e8:90:12:0f:a0:b7:d2:60:9f:9d:
        b4:20:77:ed:71:b4:54:ed:ba:82:0d:da:f2:d5:3d:d0:e5:5e:
        b7:c5:be:c4:4f:e6:5a:f6:e8:34:04:0d:f7:23:0b:77:9a:7d:
        27:9b:2d:50:5f:b9:84:b9:ec:b9:58:f3:2a:28:d8:0f:d5:d8:
        86:10:72:d7:4c:d4:3c:51:ab:3b:05:cd:99:87:af:f6:00:33:
        ff:36:20:f6:ac:0d:a6:92:88:a4:ed:78:1d:0a:13:6b:ae:6d:
        30:7d:e1:25:b2:78:a5:07:a8:e7:fd:68:4f:c0:f9:d1:65:d1:
        f4:e6:92:b1:e8:ee:29:ce:9a:f6:7f:50:5d:27:20:a4:7b:c7:
        65:13:5b:62:ae:80:83:73:a6:34:d8:6b:2c:32:ab:81:bf:4d:
        2f:7a:da:f7:71:fd:32:84:3c:a6:9c:e8:d7:0f:87:5f:14:f6:
        0b:81:74:b0:ad:1e:01:b5:b3:03:04:8b:c3:9c:e9:72:17:6b:
        b0:e0:09:d4:1c:71:d6:6f:d7:ab:1c:c3:1b:21:7b:33:30:8d:
        37:72:a4:4f		
			]]>
			</screen>
			<para>检查权限，必须是 640</para>
			<!-- [root@production ~]# chown root.freeswitch agent.pem cacert.pem -->
			<screen>
			<![CDATA[
[root@production ~]# chown -R freeswitch.daemon /etc/freeswitch/tls			
[root@production ~]# ll /etc/freeswitch/tls/{cafile.pem,agent.pem}
-rw-r----- 1 freeswitch daemon 3136 May  3 17:09 /etc/freeswitch/tls/agent.pem
-rw-r----- 1 freeswitch daemon 1192 Apr 24 11:00 /etc/freeswitch/tls/cafile.pem	
			]]>
			</screen>
		</section>
		<section>
			<title>开启TLS，监听 5061 端口</title>
			<para>编辑 /etc/freeswitch/vars.xml 配置文件，把 internal_ssl_enable 和
				external_ssl_enable 改为
			</para>
			<screen>
			<![CDATA[
[root@production ~]# cat /etc/freeswitch/vars.xml
			
  <!-- Internal SIP Profile -->
  <X-PRE-PROCESS cmd="set" data="internal_auth_calls=true"/>
  <X-PRE-PROCESS cmd="set" data="internal_sip_port=5060"/>
  <X-PRE-PROCESS cmd="set" data="internal_tls_port=5061"/>
  <X-PRE-PROCESS cmd="set" data="internal_ssl_enable=false"/>

  <!-- External SIP Profile -->
  <X-PRE-PROCESS cmd="set" data="external_auth_calls=false"/>
  <X-PRE-PROCESS cmd="set" data="external_sip_port=5080"/>
  <X-PRE-PROCESS cmd="set" data="external_tls_port=5081"/>
  <X-PRE-PROCESS cmd="set" data="external_ssl_enable=true"/>
			]]>
			</screen>
			<para>如果证书放在其他位置，需要配置下面选项指定证书位置。</para>
			<screen>
			<![CDATA[
/etc/freeswitch/sip_profiles/internal.xml:    <!--<param name="tls-cert-dir" value=""/>-->
改为 

<param name="tls-cert-dir" value="/etc/freeswitch/tls"/>
			]]>
			</screen>
		</section>
	</section>
	<section id="fusionPBX">
		<title>fusionPBX</title>
	</section>
	<section id="freeswitch.devel">
		<title>开发</title>
		<section>
			<title>FreeSWITCH 用户管理</title>
			<ulink url="https://github.com/netkiller/freeswitch" />
			<screen>
			<![CDATA[
# freeswitch 用户管理

## 安装依赖

pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

## 帮助信息

```shell
PS D:\GitHub\freeswitch> python.exe .\freeswitch.py -h
usage: freeswitch.py [-h] [-a <number> <callsign> <callgroup> [<number> <callsign> <callgroup> ...]] [-r 1000] [-l] [-s 1000] [-d]

FreeSWITCH 用户管理工具

options:
  -h, --help            show this help message and exit
  -a <number> <callsign> <callgroup> [<number> <callsign> <callgroup> ...], --add <number> <callsign> <callgroup> [<number> <callsign> <callgroup> ...]
                        添加用户
  -r 1000, --remove 1000
                        删除用户
  -l, --list            列出用户
  -s 1000, --show 1000  查看用户
  -d, --debug           调试模式

Author: netkiller - https://www.netkiller.cn/linux/

```

## 添加用户

```shell
PS D:\GitHub\freeswitch> python.exe .\freeswitch.py -a 1000 BG7NYT admin 
```

## 查看用于

```shell
PS D:\GitHub\freeswitch> python.exe .\freeswitch.py -s 1000             
<include>
        <user id="1000">
                <params>
                        <param name="password" value="B5AbNCYj"/>
                        <param name="vm-password" value="1000"/>
                </params>
                <variables>
                        <variable name="toll_allow" value="domestic,international,local"/>
                        <variable name="accountcode" value="1000"/>
                        <variable name="user_context" value="default"/>
                        <variable name="effective_caller_id_name" value="BG7NYT"/>
                        <variable name="effective_caller_id_number" value="1000"/>
                        <variable name="outbound_caller_id_name" value="$${outbound_caller_name}"/>
                        <variable name="outbound_caller_id_number" value="$${outbound_caller_id}"/>
                        <variable name="callgroup" value="admin"/>
                </variables>
        </user>
</include>
```

## 列出所有用户

```shell
PS D:\GitHub\freeswitch> python.exe .\freeswitch.py -l                  
+----------+--------+----------+----------+--------+
| 电话号码 |  呼号  |   密码   | 语音信箱 | 呼叫组 |
+==========+========+==========+==========+========+
| 1000     | BG7NYT | HbM3imgb | 2031     | admin  |
+----------+--------+----------+----------+--------+
| 1003     | BG7NYT | 1u3Fc6t4 | 5927     | 33333  |
+----------+--------+----------+----------+--------+

```

## 删除用户

```shell
PS D:\GitHub\freeswitch> python.exe .\freeswitch.py -r 1000
```			
			]]>
			</screen>
		</section>
		<section>
			<title>Java 开发包</title>
			<screen>
			<![CDATA[
        <dependency>
            <groupId>link.thingscloud</groupId>
            <artifactId>freeswitch-esl-spring-boot-starter</artifactId>
            <version>2.0.0</version>
        </dependency>		
			]]>
			</screen>
		</section>
	</section>
	<section>
		<title>备份和恢复</title>
		<para></para>
		<screen>
		<![CDATA[
tar zcvf freeswitch.tgz /etc/freeswitch/		
		]]>
		</screen>
		<para>恢复常用文件</para>
		<screen>
		<![CDATA[
 \cp -f etc/freeswitch/vars.xml /etc/freeswitch/
 \cp -f etc/freeswitch/sip_profiles/internal.xml /etc/freeswitch/sip_profiles/
 \cp -f etc/freeswitch/sip_profiles/external.xml /etc/freeswitch/sip_profiles/
 \cp -f etc/freeswitch/dialplan/default.xml /etc/freeswitch/dialplan/
 \cp -f etc/freeswitch/dialplan/public.xml /etc/freeswitch/dialplan/		
		]]>
		</screen>
		<para>恢复用户</para>
		<screen>
		<![CDATA[
 \cp -f etc/freeswitch/directory/default/* /etc/freeswitch/directory/default/		
		]]>
		</screen>
	</section>
</chapter>