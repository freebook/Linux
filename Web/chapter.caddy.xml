<?xml version="1.0" encoding="UTF-8"?>
<chapter id="index"><?dbhtml dir="caddy" ?>
	<title>Caddy</title>
	<subtitle>Caddy is a powerful, enterprise-ready, open source web server with automatic HTTPS written in Go.</subtitle>
	<section>
		<title>安装 Caddy</title>
		<screen>
		<![CDATA[
		
		]]>
		</screen>
	</section>
	<section>
		<title>启动 Caddy</title>
		<para>前台运行</para>
		<screen>
		<![CDATA[
caddy run --config /etc/caddy/Caddyfile --adapter caddyfile		
		]]>
		</screen>
		<section>
			<title>开启 QUIC</title>
			<screen>
			<![CDATA[
caddy run --config /etc/caddy/Caddyfile --adapter caddyfile --quic			
			]]>
			</screen>
		</section>
	</section>
	<section>
		<title>命令行</title>
		<section>
			<title>文件服务器</title>
			<para>将当前目录作为文件服务器的根目录</para>
			<screen>
			<![CDATA[
$ caddy file-server			
			]]>
			</screen>
			<para>指定端口</para>
			<screen>
			<![CDATA[
$ caddy file-server --listen :8080
			]]>
			</screen>
			<para>不打开 index.html，显示文件目录</para>
			<screen>
			<![CDATA[
$ caddy file-server --browse			
			]]>
			</screen>
			<para>指定文件服务器根目录</para>
			<screen>
			<![CDATA[
$ caddy file-server --root ~/public_html
			]]>
			</screen>
		</section>
	</section>
	<section>
		<title>/etc/caddy/Caddyfile</title>
		<para>
			<ulink url="https://caddyserver.com/docs/caddyfile" />
		</para>
		<section>
			<title>监听地址</title>
			<screen>
			<![CDATA[
localhost
example.com
:443
http://example.com
localhost:8080
127.0.0.1
[::1]:2015
example.com/foo/*
*.example.com
http://			
			]]>
			</screen>
			<screen>
			<![CDATA[
localhost:8080, example.com, www.example.com			
			]]>
			</screen>
			<para>泛解析</para>
			<screen>
			<![CDATA[
*.example.com			
			]]>
			</screen>
		</section>
		<section>
			<title>反向代理</title>
			<screen>
			<![CDATA[
http://api.netkiller.cn {
    reverse_proxy /* http://192.168.30.10:8080
    tls netkiller@msn.com
}			
			]]>
			</screen>
			<para>推送 X-Forwarded-For 头</para>
			<screen>
			<![CDATA[
http://www.netkiller.cn {

    root * /opt/netkiller.cn/www.netkiller.cn
    file_server

    reverse_proxy /api/* 192.168.30.10:8080 {
	    header_up X-Real-IP {http.request.remote.host}
	    header_up X-Forwarded-For {http.request.remote.host}
	}

}			
			]]>
			</screen>
			<para>反向代理自签名证书，添加 tls_insecure_skip_verify 配置项</para>
			<screen>
			<![CDATA[
netkiller.cn {
    reverse_proxy * {
        to https://192.168.0.10
        transport http {
            tls_insecure_skip_verify
        }
    }
}

api.netkiller.cn {
    reverse_proxy * {
        to 192.168.10.10:443
        transport http {
            tls
            tls_insecure_skip_verify
        }
    }
}
			]]>
			</screen>
			<para>反向代理URL前缀问题</para>
			<screen>
			<![CDATA[
举例：
www.netkiller.cn {
	reverse_proxy /api/* http://api.netkiller.cn:8080
}
访问URL: 
http://www.netkiller.cn/api/adduser

实际访问的URL是:
http://api.netkiller.cn:8080/api/adduser

我们需要的URL是：
http://api.netkiller.cn:8080/adduser
			]]>
			</screen>
			<para>解决方案</para>
			<screen>
			<![CDATA[
www.netkiller.cn {
	route /api* {
    	uri strip_prefix /api
		reverse_proxy api.netkiller.cn:8088
	}
}	
			]]>
			</screen>
		</section>
	</section>
</chapter>